<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Estatísticas de Usuários - AgendaMais</title>
    <link rel="stylesheet" th:href="@{/css/estilo.css}" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- CABEÇALHO PADRÃO -->
    <div th:replace="~{fragments/layout_cabecalho :: cabecalho}"></div>

    <div class="container-fluid mt-4">
      <!-- Filtro Situação do Usuário -->
      <form method="get" class="row mb-4 align-items-end" action="/administrador/estatistica-usuarios">
        <div class="col-auto">
          <label for="filtroSituacao" class="form-label fw-bold mb-0">Situação:</label>
        </div>
        <div class="col-auto">
          <select id="filtroSituacao" name="situacao" class="form-select">
            <option th:value="" th:selected="${situacao == null or situacao == ''}">Todos</option>
            <option th:value="A" th:selected="${situacao == 'A'}">Ativos</option>
            <option th:value="B" th:selected="${situacao == 'B'}">Bloqueados</option>
            <option th:value="C" th:selected="${situacao == 'C'}">Cancelados</option>
          </select>
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-primary">Filtrar</button>
        </div>
      </form>
      <!-- Título da Página -->
      <div class="row mb-4">
        <div class="col-12">
          <h2>
            <i class="fas fa-chart-bar me-2 text-primary"></i>
            Estatísticas de Usuários
          </h2>
          <p class="text-muted">Análise dos usuários do sistema</p>
        </div>
      </div>

      <!-- Alertas -->
      <div
        th:if="${mensagem}"
        class="alert alert-success alert-dismissible fade show"
        role="alert"
      >
        <i class="fas fa-check-circle"></i> <span th:text="${mensagem}"></span>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>

      <div
        th:if="${erro}"
        class="alert alert-danger alert-dismissible fade show"
        role="alert"
      >
        <i class="fas fa-exclamation-circle"></i>
        <span th:text="${erro}"></span>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>

      <!-- Link Ver Gráficos -->
      <div class="row mb-2">
        <div class="col-12 text-end">
          <a
            href="/administrador/estatistica-usuarios/graficos"
            class="btn btn-outline-primary"
          >
            <i class="fas fa-chart-pie me-2"></i>Ver Gráficos
          </a>
        </div>
      </div>
      <!-- Estatísticas Básicas e Gráficos -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card bg-primary text-white">
            <div class="card-body text-center">
              <i class="fas fa-users fa-2x mb-3"></i>
              <h3 th:text="${totalUsuarios ?: 0}">0</h3>
              <p>Total de Usuários</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card bg-success text-white">
            <div class="card-body text-center">
              <i class="fas fa-building fa-2x mb-3"></i>
              <h3 th:text="${totalInstituicoes ?: 0}">0</h3>
              <p>Total de Instituições</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card bg-info text-white">
            <div class="card-body text-center">
              <i class="fas fa-link fa-2x mb-3"></i>
              <h3 th:text="${totalVinculos ?: 0}">0</h3>
              <p>Total de Vínculos</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Gráficos de Pizza -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header bg-light">
              <b>Distribuição por Nível de Acesso</b>
            </div>
            <div class="card-body">
              <canvas id="pieNivelAcesso"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header bg-light">
              <b>Distribuição por Situação</b>
            </div>
            <div class="card-body">
              <canvas id="pieSituacao"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Informações da Sessão (Debug) -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5>Informações de Debug</h5>
            </div>
            <div class="card-body">
              <p>
                <strong>Usuário Logado:</strong>
                <span th:text="${usuarioLogado?.nome ?: 'N/A'}">N/A</span>
              </p>
              <p>
                <strong>Instituição:</strong>
                <span
                  th:text="${instituicaoSelecionada?.nomeInstituicao ?: 'N/A'}"
                  >N/A</span
                >
              </p>
              <p>
                <strong>Nível de Acesso:</strong>
                <span th:text="${nivelAcessoAtual ?: 'N/A'}">N/A</span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Botões de Ação -->
      <div class="row mt-4">
        <div class="col-12 text-center">
          <div
            th:replace="fragments/botao_retornar_menu :: botao-retornar-menu('/administrador')"
          ></div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script th:inline="javascript">
      /*<![CDATA[*/
      // Serializa arrays Thymeleaf para JavaScript
      const nivelLabels = /*[[${nivelLabels}]]*/ [];
      const nivelCounts = /*[[${nivelCounts}]]*/ [];
      const situacaoLabels = /*[[${situacaoLabels}]]*/ [];
      const situacaoCounts = /*[[${situacaoCounts}]]*/ [];

      // Gráfico de pizza - Nível de Acesso
      new Chart(document.getElementById("pieNivelAcesso"), {
        type: "pie",
        data: {
          labels: nivelLabels,
          datasets: [
            {
              data: nivelCounts,
              backgroundColor: [
                "#007bff",
                "#ffc107",
                "#28a745",
                "#dc3545",
                "#6c757d",
                "#17a2b8",
              ],
            },
          ],
        },
        options: {
          responsive: true,
          plugins: { legend: { position: "bottom" } },
        },
      });

      // Gráfico de pizza - Situação
      new Chart(document.getElementById("pieSituacao"), {
        type: "pie",
        data: {
          labels: situacaoLabels,
          datasets: [
            {
              data: situacaoCounts,
              backgroundColor: ["#28a745", "#ffc107", "#dc3545", "#6c757d"],
            },
          ],
        },
        options: {
          responsive: true,
          plugins: { legend: { position: "bottom" } },
        },
      });
      /*]]>*/
    </script>
  </body>
</html>
