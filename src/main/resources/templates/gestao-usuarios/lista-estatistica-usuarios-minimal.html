<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista Estatística de Usuários</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <!-- Header -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Lista Estatística de Usuários - <span th:text="${nomeInstituicao}">Instituto</span>
                        </h4>
                        <small>Total de usuários: <span th:text="${totalUsuarios}">0</span></small>
                    </div>
                </div>

                <!-- Controles de Ordenação -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <label for="ordenacao" class="form-label fw-bold">Ordenação:</label>
                                <select id="ordenacao" class="form-select" onchange="ordenarTabela()">
                                    <option value="geografica">Por País/Estado/Cidade</option>
                                    <option value="percentual-desc">Por Relevância % (Maior → Menor)</option>
                                    <option value="percentual-asc">Por Relevância % (Menor → Maior)</option>
                                </select>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-success" onclick="exportarCSV()">
                                    <i class="fas fa-file-csv me-1"></i>
                                    Exportar CSV
                                </button>
                                <a href="/administrador/lista-usuarios" class="btn btn-secondary ms-2">
                                    <i class="fas fa-arrow-left me-1"></i>
                                    Voltar
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Estatísticas -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="tabelaEstatisticas" class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">Nível</th>
                                        <th scope="col">País</th>
                                        <th scope="col">Estado</th>
                                        <th scope="col">Cidade</th>
                                        <th scope="col" class="text-center">Usuários</th>
                                        <th scope="col" class="text-center">Relevância %</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Debug: mostrar se existem países -->
                                    <tr th:if="${estatisticasPaises == null or #lists.isEmpty(estatisticasPaises)}">
                                        <td colspan="6" class="text-center text-muted py-4">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>DEBUG:</strong> Nenhuma estatística disponível 
                                            (estatisticasPaises = <span th:text="${estatisticasPaises}">null</span>)
                                        </td>
                                    </tr>
                                    
                                    <!-- Iterar através dos países DE FORMA SIMPLES -->
                                    <tr th:each="pais : ${estatisticasPaises}" class="table-primary">
                                        <td><i class="fas fa-globe text-primary"></i> País</td>
                                        <td class="fw-bold" th:text="${pais.nome}">País</td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td class="text-center" th:text="${pais.quantidade}">0</td>
                                        <td class="text-center" th:text="${pais.percentual} + '%'">0%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        function ordenarTabela() {
            const select = document.getElementById('ordenacao');
            const tabela = document.getElementById('tabelaEstatisticas');
            const tbody = tabela.querySelector('tbody');
            const linhas = Array.from(tbody.querySelectorAll('tr'));
            
            // Filtrar apenas linhas com dados (ignorar mensagem de vazio)
            const linhasComDados = linhas.filter(linha => 
                !linha.textContent.includes('Nenhuma estatística disponível')
            );
            
            if (linhasComDados.length === 0) return;
            
            // Ordenar baseado na seleção
            switch (select.value) {
                case 'geografica':
                    // Manter ordem original (países → estados → cidades)
                    location.reload();
                    break;
                    
                case 'percentual-desc':
                    linhasComDados.sort((a, b) => {
                        const percentA = parseFloat(a.cells[5].textContent.replace('%', ''));
                        const percentB = parseFloat(b.cells[5].textContent.replace('%', ''));
                        return percentB - percentA;
                    });
                    break;
                    
                case 'percentual-asc':
                    linhasComDados.sort((a, b) => {
                        const percentA = parseFloat(a.cells[5].textContent.replace('%', ''));
                        const percentB = parseFloat(b.cells[5].textContent.replace('%', ''));
                        return percentA - percentB;
                    });
                    break;
            }
            
            if (select.value !== 'geografica') {
                // Limpar tbody e adicionar linhas ordenadas
                tbody.innerHTML = '';
                linhasComDados.forEach(linha => tbody.appendChild(linha));
            }
        }
        
        function exportarCSV() {
            const tabela = document.getElementById('tabelaEstatisticas');
            let csv = 'Nível;País;Estado;Cidade;Usuários;Relevância %\\n';
            
            const linhas = tabela.querySelectorAll('tbody tr');
            
            linhas.forEach(linha => {
                if (!linha.textContent.includes('Nenhuma estatística disponível')) {
                    const colunas = linha.querySelectorAll('td');
                    const linha_csv = Array.from(colunas).map(coluna => {
                        // Limpar ícones e espaços extras
                        return coluna.textContent.replace(/\\s+/g, ' ').trim();
                    }).join(';');
                    csv += linha_csv + '\\n';
                }
            });
            
            // Download do arquivo
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'lista-estatistica-usuarios.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
