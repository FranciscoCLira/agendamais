<!-- Botão 'Retornar ao Menu' removido conforme solicitado -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Gestão de Usuários</title>
    <link rel="stylesheet" th:href="@{/css/estilo.css}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- CABEÇALHO PADRÃO -->
    <div th:replace="~{fragments/layout_cabecalho :: cabecalho}"></div>

    <div class="container mt-4">
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a
              th:href="@{/administrador(page=${page},size=${size},filtro=${filtro})}"
              th:if="${nivelAcessoLogado == 5}"
            >
              <i class="fas fa-home"></i> Administrador
            </a>
            <a
              th:href="@{/superusuario(page=${page},size=${size},filtro=${filtro})}"
              th:if="${nivelAcessoLogado == 9}"
            >
              <i class="fas fa-home"></i> SuperUsuário
            </a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">
            <i class="fas fa-users"></i> Gestão de Usuários
          </li>
        </ol>
      </nav>

      <!-- Título da Página e botão Editar Usuários -->
      <div class="row mb-2 align-items-center">
        <div class="col-8">
          <h2 class="mb-1">
            <i class="fas fa-users me-2 text-primary"></i>
            Gestão de Usuários -
            <span th:if="${instituicaoSelecionada != null}" th:text="${instituicaoSelecionada.nomeInstituicao}">Instituição</span>
            <span th:unless="${instituicaoSelecionada != null}">Instituição não selecionada</span>
          </h2>
        </div>
        <div class="col-4 text-end">
          <a
            th:if="${nivelAcessoLogado >= 5}"
            th:href="@{/administrador/editar-usuarios}"
            class="btn btn-outline-primary"
          >
            <i class="fas fa-edit me-1"></i> Editar Usuários
          </a>
        </div>
      </div>

      <!-- Mensagens -->
      <div
        th:if="${mensagemSucesso}"
        class="alert alert-success alert-dismissible fade show"
        role="alert"
      >
        <i class="fas fa-check-circle me-2"></i>
        <span th:text="${mensagemSucesso}"></span>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>

      <div
        th:if="${mensagemErro}"
        class="alert alert-danger alert-dismissible fade show"
        role="alert"
      >
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span th:text="${mensagemErro}"></span>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>

      <!-- Filtros em duas linhas -->
      <form method="get" class="mb-3" th:action="@{/administrador/usuarios}">
        <div class="row align-items-end mb-1">
          <div class="col-md-2">
            <label for="filtroCodigo" class="form-label mb-0">Código</label>
            <input
              type="text"
              class="form-control"
              name="filtroCodigo"
              id="filtroCodigo"
              th:value="${filtroCodigo}"
              placeholder="Login"
            />
          </div>
          <div class="col-md-2">
            <label for="filtroNome" class="form-label mb-0">Nome</label>
            <input
              type="text"
              class="form-control"
              name="filtroNome"
              id="filtroNome"
              th:value="${filtroNome}"
              placeholder="Nome do Usuário"
            />
          </div>
          <div class="col-md-2">
            <label for="filtroEmail" class="form-label mb-0">Email</label>
            <input
              type="text"
              class="form-control"
              name="filtroEmail"
              id="filtroEmail"
              th:value="${filtroEmail}"
              placeholder="Email"
            />
          </div>
          <div class="col-md-2">
            <label for="filtroSubInstituicao" class="form-label mb-0"
              >Sub-Instituição</label>
            <!-- Filtro Sub-Instituição -->
            <select class="form-select" name="filtroSubInstituicao" onchange="this.form.submit()">
                <option value="Todas" th:selected="${filtroSubInstituicao == null or filtroSubInstituicao == 'Todas'}">Todas</option>
                <option th:each="sub : ${subInstituicoes}" th:value="${sub.id}" th:text="${sub.nomeSubInstituicao}"
                    th:selected="${filtroSubInstituicao != null and filtroSubInstituicao == sub.id.toString()}">
                <option value="Nenhuma" th:selected="${filtroSubInstituicao == 'Nenhuma'}">Nenhuma</option>
            </select>
          </div>
          <div class="col-md-2">
            <label for="filtroStatus" class="form-label mb-0">Sit.</label>
          <!-- Filtro Situação -->
          <select class="form-select" name="filtroStatus" onchange="this.form.submit()">
              <option value="Todos" th:selected="${filtroStatus == null or filtroStatus == 'Todos'}">Todas</option>
              <option value="A" th:selected="${filtroStatus == 'A'}">A = Ativo</option>
              <option value="B" th:selected="${filtroStatus == 'B'}">B = Bloqueado</option>
              <option value="C" th:selected="${filtroStatus == 'C'}">C = Cancelado</option>
          </select>
          </div>
          <div class="col-md-2 d-flex align-items-end gap-2">
            <button type="submit" class="btn btn-primary w-100">
              <i class="fas fa-filter me-2"></i>Filtrar
            </button>
            <a th:href="@{/administrador/usuarios}" class="btn btn-outline-secondary w-100"
              >Limpar</a
            >
          </div>
        </div>
        <div class="row align-items-end">
          <div class="col-md-2">
            <label for="filtroPais" class="form-label mb-0">País</label>
            <input
              type="text"
              class="form-control"
              name="filtroPais"
              id="filtroPais"
              th:value="${filtroPais}"
              placeholder="País"
            />
          </div>
          <div class="col-md-2">
            <label for="filtroEstado" class="form-label mb-0">Estado</label>
            <input
              type="text"
              class="form-control"
              name="filtroEstado"
              id="filtroEstado"
              th:value="${filtroEstado}"
              placeholder="Estado"
            />
          </div>
          <div class="col-md-2">
            <label for="filtroCidade" class="form-label mb-0">Cidade</label>
            <input
              type="text"
              class="form-control"
              name="filtroCidade"
              id="filtroCidade"
              th:value="${filtroCidade}"
              placeholder="Cidade"
            />
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <select
              class="form-select"
              name="size"
              onchange="this.form.submit()"
            >
              <option th:value="10" th:selected="${size == 10}">010</option>
              <option th:value="100" th:selected="${size == 100}">100</option>
              <option th:value="200" th:selected="${size == 200}">200</option>
              <option th:value="300" th:selected="${size == 300}">300</option>
              <option th:value="400" th:selected="${size == 400}">400</option>
              <option th:value="500" th:selected="${size == 500}">500</option>
            </select>
          </div>
        </div>
      </form>

      <!-- Tabela de Usuários -->
      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>
            Lista de Usuários (<span
              th:text="${usuarios != null ? usuarios.size() : 0}"
              >0</span
            >
            usuários listados)
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0" id="tabelaUsuarios">
              <thead class="table-light">
                <tr>
                  <th><i class="fas fa-hashtag"></i> Código</th>
                  <th><i class="fas fa-user"></i> Nome</th>
                  <th><i class="fas fa-envelope"></i> Email</th>
                  <th><i class="fas fa-globe"></i> País/Estado/Cidade</th>
                  <th><i class="fas fa-mobile-alt"></i> Celular</th>
                  <th><i class="fas fa-sitemap"></i> Sub-Instituição</th>
                  <th><i class="fas fa-user-tag"></i> Nível</th>
                  <th>Debug Nível</th>
                  <th>Debug Autor</th>
                  <th><i class="fas fa-toggle-on"></i> Sit.</th>
                  <th><i class="fas fa-cogs"></i> Ações</th>
                </tr>
              </thead>
    <tbody th:if="${usuarios != null and #lists.size(usuarios) > 0}">
      <tr th:each="usuarioInst,iter : ${usuarios}" class="linha-usuario">
        <td th:text="${usuarioInst.username} ?: '---'">U001</td> 

        <td>
          <strong th:if="${usuarioInst.pessoaDisponivel}" th:text="${usuarioInst.nomePessoa} ?: ''">Nome do Usuário</strong>
          <span th:unless="${usuarioInst.pessoaDisponivel}" class="text-muted"><em>Não informado</em></span>
        </td>      
       
        <td>
          <span th:if="${usuarioInst.pessoaDisponivel}" th:text="${usuarioInst.emailPessoa} ?: ''">email@exemplo.com</span>
          <span th:unless="${usuarioInst.pessoaDisponivel}" class="text-muted"><em>Não informado</em></span>
        </td>
        <td>
          <span th:text="${usuarioInst.localizacaoFormatada}"></span>
        </td>
        <td>
          <span th:text="${usuarioInst.celularFormatado}"></span>
        </td>
        <td>
          <span th:text="${usuarioInst.subInstituicaoNome}"></span>
        </td>
        <td class="text-center" th:text="${usuarioInst.nivelAcesso}"></td>
        <td th:text="${usuarioInst.nivelAcesso}"></td>
        <td th:text="${usuarioInst.autorDisponivel}"></td>
        <td>
          <span th:switch="${usuarioInst.situacaoAcesso}">
            <span th:case="'A'" class="badge" style="background-color: #28a745; color: #fff">A</span>
            <span th:case="'B'" class="badge" style="background-color: #ff9800; color: #fff">B</span>
            <span th:case="'C'" class="badge" style="background-color: #dc3545; color: #fff">C</span>
            <span th:case="*" class="badge bg-secondary" th:text="${usuarioInst.situacaoAcesso} ?: '-'">-</span>
          </span>
        </td>
        <td>
          <!-- Ícone Editar Usuário -->
          <a th:if="${usuarioInst != null and usuarioInst.pessoaDisponivel}"
            href="#"
            title="Editar Usuário"
            class="me-2"
            data-bs-toggle="modal"
            data-bs-target="#modalEditarUsuario"
            th:data-usuario-id="${usuarioInst.usuarioInstituicao != null ? usuarioInst.usuarioInstituicao.id : ''}"
            th:data-nivel-acesso="${usuarioInst.nivelAcesso} ?: ''"
            th:data-situacao-acesso="${usuarioInst.situacaoAcesso} ?: ''"
            th:data-nome-pessoa="${usuarioInst.nomePessoa} ?: ''"
            th:data-email-pessoa="${usuarioInst.emailPessoa} ?: ''"
            th:data-subinstituicao="${usuarioInst.subInstituicaoNome} ?: ''"
            th:data-subinstituicao-id="${usuarioInst.subInstituicaoId} ?: ''"
            th:data-identificacao="${usuarioInst.identificacaoPessoaSubInstituicao} ?: ''"
            onclick="carregarDadosUsuario(this)">
            <i class="fas fa-pencil-alt" style="font-size: 1.1em;"></i>
          </a>
          <!-- Ícone Editar Autor -->
          <a th:if="${usuarioInst != null and usuarioInst.autorDisponivel}"
      th:href="@{/administrador/autor-form/{id}(
        id=${usuarioInst.usuarioInstituicao != null && usuarioInst.usuarioInstituicao.getUsuario() != null && usuarioInst.usuarioInstituicao.getUsuario().getPessoa() != null && usuarioInst.usuarioInstituicao.getUsuario().getPessoa().getAutor() != null ? usuarioInst.usuarioInstituicao.getUsuario().getPessoa().getAutor().getId() : ''},
        origem='usuarios',
        filtroCodigo=${filtroCodigo},
        filtroNome=${filtroNome},
        filtroEmail=${filtroEmail},
        filtroSubInstituicao=${filtroSubInstituicao},
        filtroStatus=${filtroStatus},
        filtroPais=${filtroPais},
        filtroEstado=${filtroEstado},
        filtroCidade=${filtroCidade},
        size=${size},
        page=${page}
      )}"
      title="Editar Autor">
            <i class="fas fa-user-edit text-primary" style="font-size: 1.1em;"></i>
          </a>
          <i th:if="${usuarioInst == null or !usuarioInst.autorDisponivel}"
            class="fas fa-user-edit text-secondary" style="font-size: 1.1em; opacity: 0.4; cursor: not-allowed;" title="Não é Autor"></i>
        </td>
      </tr>
    </tbody>
    <tbody th:unless="${usuarios != null and #lists.size(usuarios) > 0}">
      <tr><td colspan="12" class="text-center text-muted">Nenhum usuário encontrado.</td></tr>
    </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Paginação -->
      <th:block th:if="${usuarios != null and usuarios.size() > 0 and totalPages > 1}">
        <nav class="mt-4">
          <ul class="pagination justify-content-center">
            <li class="page-item" th:classappend="${page == 0} ? 'disabled'">
              <a
                class="page-link"
                th:href="@{/administrador/usuarios(page=${(page ?: 0) > 0 ? (page ?: 0) - 1 : 0},size=${size},filtroCodigo=${filtroCodigo},filtroNome=${filtroNome},filtroEmail=${filtroEmail},filtroSubInstituicao=${filtroSubInstituicao},filtroStatus=${filtroStatus},filtroPais=${filtroPais},filtroEstado=${filtroEstado},filtroCidade=${filtroCidade})}"
              >Anterior</a>
            </li>
            <li
              class="page-item"
              th:each="i : ${#numbers.sequence(0, (totalPages ?: 1) - 1)}"
              th:classappend="${i == (page ?: 0)} ? 'active'"
            >
              <a
                class="page-link"
                th:href="@{/administrador/usuarios(page=${i},size=${size},filtroCodigo=${filtroCodigo},filtroNome=${filtroNome},filtroEmail=${filtroEmail},filtroSubInstituicao=${filtroSubInstituicao},filtroStatus=${filtroStatus},filtroPais=${filtroPais},filtroEstado=${filtroEstado},filtroCidade=${filtroCidade})}"
                th:text="${i+1}"
              ></a>
            </li>
            <li
              class="page-item"
              th:classappend="${page == ((totalPages ?: 1) - 1)} ? 'disabled'"
            >
              <a
                class="page-link"
                th:href="@{/administrador/usuarios(page=${(page ?: 0) + 1},size=${size},filtroCodigo=${filtroCodigo},filtroNome=${filtroNome},filtroEmail=${filtroEmail},filtroSubInstituicao=${filtroSubInstituicao},filtroStatus=${filtroStatus},filtroPais=${filtroPais},filtroEstado=${filtroEstado},filtroCidade=${filtroCidade})}"
              >Próxima</a>
            </li>
          </ul>
        </nav>
      </th:block>
      <!-- Navegação -->
      <div th:if="${totalPages <= 1 || usuarios == null || usuarios.size() == 0}" class="my-4"></div>
      <a
        href="/administrador"
        th:if="${nivelAcessoLogado == 5}"
        class="btn btn-secondary"
      >
        <i class="fas fa-arrow-left me-2"></i>Voltar ao Menu Administrador
      </a>
      <a
        href="/superusuario"
        th:if="${nivelAcessoLogado == 9}"
        class="btn btn-secondary"
      >
          <i class="fas fa-arrow-left me-2"></i>Voltar ao Menu SuperUsuário
        </a>
      </div>
    </div>

    <!-- Modal para Editar Usuário -->
    <div class="modal fade" id="modalEditarUsuario" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-user-edit me-2"></i>Editar Usuário
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <form action="/administrador/atualizar-usuario" method="post">
            <div class="modal-body">
              <input
                type="hidden"
                id="usuarioInstituicaoId"
                name="usuarioInstituicaoId"
              />
              <div class="mb-3">
                <label for="nomeUsuarioModal" class="form-label">Nome do Usuário:</label>
                <input type="text" class="form-control" id="nomeUsuarioModal" name="nomeUsuario" required />
              </div>
              <div class="mb-3">
                <label for="emailUsuarioModal" class="form-label">Email:</label>
                <input type="email" class="form-control" id="emailUsuarioModal" name="emailUsuario" required />
              </div>
              <div class="mb-3">
                <label for="subInstituicaoUsuarioModal" class="form-label">Sub-Instituição:</label>
                <select class="form-select" id="subInstituicaoUsuarioModal" name="subInstituicaoUsuario">
                  <option value="" th:selected="${subInstituicaoUsuario == null || subInstituicaoUsuario == ''}">Manter atual</option>
                  <option th:each="sub : ${subInstituicoes}" th:value="${sub.id}" th:text="${sub.nomeSubInstituicao}" th:selected="${subInstituicaoUsuario == sub.id}"></option>
                  <option value="-1" th:selected="${subInstituicaoUsuario == '-1'}">Nenhuma</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="identificacaoPessoaSubInstituicao" class="form-label">Identificação Sub-Inst.:</label>
                <input type="text" class="form-control" id="identificacaoPessoaSubInstituicao" name="identificacaoPessoaSubInstituicao"
                      th:value="${identificacaoPessoaSubInstituicao}" />
              </div>
              <div class="mb-3">
                <label for="nivelAcessoUsuarioInstituicao" class="form-label"
                  >Nível de Acesso:</label
                >
                <select
                  class="form-select"
                  id="nivelAcessoUsuarioInstituicao"
                  name="nivelAcessoUsuarioInstituicao"
                  required
                >
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="5">5</option>
                  <option value="9" th:if="${nivelAcessoLogado == 9}">9</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="sitAcessoUsuarioInstituicao" class="form-label"
                  >Situação de Acesso:</label
                >
                <select
                  class="form-select"
                  id="sitAcessoUsuarioInstituicao"
                  name="sitAcessoUsuarioInstituicao"
                  required
                >
                  <option value="A">A</option>
                  <option value="B">B</option>
                  <option value="C">C</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                <i class="fas fa-times me-2"></i>Cancelar
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>Salvar Alterações
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Filtro de busca agora é feito no servidor (form GET)

      // Carregar dados no modal
      function carregarDadosUsuario(button) {
        const id = button.getAttribute("data-usuario-id");
        const nivel = button.getAttribute("data-nivel-acesso");
        const situacao = button.getAttribute("data-situacao-acesso");
        const nome = button.getAttribute("data-nome-pessoa");
        const email = button.getAttribute("data-email-pessoa");
  let subinstId = button.getAttribute("data-subinstituicao-id");
  let identificacao = button.getAttribute("data-identificacao");
  // Se não houver sub-instituição, setar para '' (Manter atual)
  if (!subinstId) subinstId = '';

  document.getElementById("usuarioInstituicaoId").value = id;
  document.getElementById("nomeUsuarioModal").value = nome;
  document.getElementById("emailUsuarioModal").value = email;
  document.getElementById("subInstituicaoUsuarioModal").value = subinstId;
  document.getElementById("identificacaoPessoaSubInstituicao").value = identificacao || '';
  document.getElementById("nivelAcessoUsuarioInstituicao").value = nivel;
  document.getElementById("sitAcessoUsuarioInstituicao").value = situacao;
      }
      // Redirecionar para /usuarios após salvar no modal
      document.addEventListener('DOMContentLoaded', function() {
        const modalForm = document.querySelector('#modalEditarUsuario form');
        if (modalForm) {
          modalForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.target;
            const data = new FormData(form);
            fetch(form.action, {
              method: 'POST',
              body: data
            }).then(() => {
              window.location.href = '/administrador/usuarios';
            });
          });
        }
      });
    </script>
  </body>
</html>
