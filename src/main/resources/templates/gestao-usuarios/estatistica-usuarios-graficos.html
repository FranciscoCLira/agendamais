<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Gráficos de Estatísticas de Usuários</title>
    <link rel="stylesheet" th:href="@{/css/estilo.css}" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
  <!-- CABEÇALHO PADRÃO -->
  <div th:replace="~{fragments/layout_cabecalho :: cabecalho}"></div>
  <div class="container mt-4">
  <!-- <div th:text="${paisesOrdenadosJson}">DEBUG_JSON</div> -->
    <div class="mb-3">
      <label for="inputLimiar" class="form-label fw-bold">Agrupar percentual inferior a:</label>
      <div class="input-group" style="max-width: 300px;">
        <input type="number" min="0" max="100" step="0.1" id="inputLimiar" class="form-control" value="5">
        <span class="input-group-text">%</span>
      </div>
      <div class="form-text">Nome no gráfico: <span id="exemploAgrupamento">n Agrupados (&lt; 5%)</span></div>
    </div>
      <h2>
        <i class="fas fa-chart-pie me-2 text-primary"></i> Gráficos de
        Estatísticas de Usuários
      </h2>
      <a
        href="/administrador/estatistica-usuarios"
        class="btn btn-secondary mb-3"
        ><i class="fas fa-arrow-left"></i> Voltar</a
      >
      <div class="row">
        <div class="col-md-4">
          <div class="card mb-4">
            <div class="card-header bg-primary text-white">Por País</div>
            <div class="card-body">
              <canvas id="graficoPais"></canvas>
              <ul id="legendaPais" class="mt-2 mb-0 ps-3 small"></ul>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card mb-4">
            <div class="card-header bg-success text-white">Por Estado</div>
            <div class="card-body">
              <canvas id="graficoEstado"></canvas>
              <ul id="legendaEstado" class="mt-2 mb-0 ps-3 small"></ul>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card mb-4">
            <div class="card-header bg-info text-white">Por Cidade</div>
            <div class="card-body">
              <canvas id="graficoCidade"></canvas>
              <ul id="legendaCidade" class="mt-2 mb-0 ps-3 small"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script th:inline="javascript">
  window.onload = function() {
    // Função para atualizar legendas de agrupados
    function atualizarLegendaAgrupados(dados, limiar, ulId) {
      var ul = document.getElementById(ulId);
      if (!ul) return;
      ul.innerHTML = '';
      var agrupado = dados.find(function(e) { return typeof e[0] === 'string' && e[0].includes('Agrupados'); });
      if (agrupado) {
        var li = document.createElement('li');
        li.innerHTML = '<strong>' + agrupado[0] + '</strong>: ' + agrupado[1];
        ul.appendChild(li);
      }
    }
    var inputLimiar = document.getElementById('inputLimiar');
    var spanExemplo = document.getElementById('exemploAgrupamento');
    if (!inputLimiar || !spanExemplo) return;
    // Função para agrupar menores
    function agruparMenores(dados, limiar) {
      var total = dados.reduce((acc, cur) => acc + cur[1], 0);
      var maiores = [];
      var agrupados = 0;
      dados.forEach(function (item) {
        var perc = (item[1] * 100) / total;
        if (perc >= limiar) {
          maiores.push(item);
        } else {
          agrupados += item[1];
        }
      });
      if (agrupados > 0) {
        maiores.push([agrupados + ' Agrupados (< ' + limiar + '%)', agrupados]);
      }
      return maiores;
    }

    // Função para criar gráfico e permitir atualização
    var chartPais, chartEstado, chartCidade;
    function criarGraficoPie(ctx, dados, cores) {
      var total = dados.reduce((acc, cur) => acc + cur[1], 0);
      return new Chart(ctx, {
        type: "pie",
        data: {
          labels: dados.map((e) => e[0]),
          datasets: [
            {
              data: dados.map((e) => e[1]),
              backgroundColor: cores,
            },
          ],
        },
        options: {
          plugins: {
            tooltip: {
              callbacks: {
                label: function (context) {
                  var label = context.label || "";
                  var value = context.parsed;
                  var perc = total > 0 ? ((value * 100) / total).toFixed(1) : 0;
                  return label + ": " + value + " (" + perc + "%)";
                },
              },
            },
          },
        },
      });
    }

    var coresPais = ["#007bff", "#28a745", "#ffc107", "#17a2b8", "#dc3545", "#6c757d", "#8e44ad"];
    var coresEstado = ["#28a745", "#007bff", "#ffc107", "#17a2b8", "#dc3545", "#6c757d", "#8e44ad"];
    var coresCidade = ["#17a2b8", "#007bff", "#28a745", "#ffc107", "#dc3545", "#6c757d", "#8e44ad"];

    function atualizarGraficos() {
      var limiar = parseFloat(document.getElementById('inputLimiar').value) || 0;
      document.getElementById('exemploAgrupamento').textContent = 'n Agrupados (< ' + limiar + '%)';
      if (chartPais) chartPais.destroy();
      if (chartEstado) chartEstado.destroy();
      if (chartCidade) chartCidade.destroy();
      var dadosPaisAgrup = agruparMenores(dadosPais, limiar);
      var dadosEstadoAgrup = agruparMenores(dadosEstado, limiar);
      var dadosCidadeAgrup = agruparMenores(dadosCidade, limiar);
      chartPais = criarGraficoPie(
        document.getElementById("graficoPais"),
        dadosPaisAgrup,
        coresPais
      );
      chartEstado = criarGraficoPie(
        document.getElementById("graficoEstado"),
        dadosEstadoAgrup,
        coresEstado
      );
      chartCidade = criarGraficoPie(
        document.getElementById("graficoCidade"),
        dadosCidadeAgrup,
        coresCidade
      );
      atualizarLegendaAgrupados(dadosPaisAgrup, limiar, 'legendaPais');
      atualizarLegendaAgrupados(dadosEstadoAgrup, limiar, 'legendaEstado');
      atualizarLegendaAgrupados(dadosCidadeAgrup, limiar, 'legendaCidade');
    }

    document.getElementById('inputLimiar').addEventListener('input', atualizarGraficos);
    atualizarGraficos();
  }
  var dadosPais = /*[[${paisesOrdenadosJson}]]*/ '[]';
  var dadosEstado = /*[[${estadosOrdenadosJson}]]*/ '[]';
  var dadosCidade = /*[[${cidadesOrdenadasJson}]]*/ '[]';
  try { dadosPais = JSON.parse(dadosPais); } catch (e) { dadosPais = []; }
  try { dadosEstado = JSON.parse(dadosEstado); } catch (e) { dadosEstado = []; }
  try { dadosCidade = JSON.parse(dadosCidade); } catch (e) { dadosCidade = []; }
  // Garante formato array de arrays para os gráficos
  if (Array.isArray(dadosPais) && dadosPais.length > 0 && typeof dadosPais[0] === 'object' && !Array.isArray(dadosPais[0])) {
    dadosPais = dadosPais.map(function(e) { return [e.key, e.value]; });
  }
  if (Array.isArray(dadosEstado) && dadosEstado.length > 0 && typeof dadosEstado[0] === 'object' && !Array.isArray(dadosEstado[0])) {
    dadosEstado = dadosEstado.map(function(e) { return [e.key, e.value]; });
  }
  if (Array.isArray(dadosCidade) && dadosCidade.length > 0 && typeof dadosCidade[0] === 'object' && !Array.isArray(dadosCidade[0])) {
    dadosCidade = dadosCidade.map(function(e) { return [e.key, e.value]; });
  }

      function agruparMenores(dados, limiar) {
        var total = dados.reduce((acc, cur) => acc + cur[1], 0);
        var maiores = [];
        var agrupados = 0;
        dados.forEach(function (item) {
          var perc = (item[1] * 100) / total;
          if (perc >= limiar) {
            maiores.push(item);
          } else {
            agrupados += item[1];
          }
        });
        if (agrupados > 0) {
          maiores.push([agrupados + ' Agrupados (<' + limiar + '%)', agrupados]);
        }
        return maiores;
      }

      function criarGraficoPie(ctx, dados, cores) {
        var total = dados.reduce((acc, cur) => acc + cur[1], 0);
        return new Chart(ctx, {
          type: "pie",
          data: {
            labels: dados.map((e) => e[0]),
            datasets: [
              {
                data: dados.map((e) => e[1]),
                backgroundColor: cores,
              },
            ],
          },
          options: {
            plugins: {
              tooltip: {
                callbacks: {
                  label: function (context) {
                    var label = context.label || "";
                    var value = context.parsed;
                    var perc = total > 0 ? ((value * 100) / total).toFixed(1) : 0;
                    return label + ": " + value + " (" + perc + "%)";
                  },
                },
              },
            },
          },
        });
      }


  // Dados reais do backend (Thymeleaf) - serializados como JSON

  // ...já tratado acima, não precisa duplicar...

      var coresPais = ["#007bff", "#28a745", "#ffc107", "#17a2b8", "#dc3545", "#6c757d", "#8e44ad"];
      var coresEstado = ["#28a745", "#007bff", "#ffc107", "#17a2b8", "#dc3545", "#6c757d", "#8e44ad"];
      var coresCidade = ["#17a2b8", "#007bff", "#28a745", "#ffc107", "#dc3545", "#6c757d", "#8e44ad"];
    </script>
  </body>
</html>
