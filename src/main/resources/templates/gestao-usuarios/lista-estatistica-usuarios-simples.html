<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista Estatística de Usuários - AgendaMais</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="alert alert-primary">
            <h2><i class="fas fa-list-alt me-3"></i>Lista Estatística de Usuários</h2>
            <p th:text="'Instituição: ' + (${nomeInstituicao} ?: 'Teste')"></p>
            <p th:text="'Total de usuários: ' + (${totalUsuarios} ?: '0')"></p>
        </div>

        <!-- Erro Debug -->
        <div th:if="${erro}" class="alert alert-warning" th:text="${erro}"></div>

        <!-- Controles -->
        <div class="mb-3">
            <label>Ordenação:</label>
            <select id="sortOrder" class="form-select w-auto d-inline" onchange="sortTable()">
                <option value="geographic">Por País/Estado/Cidade</option>
                <option value="percentage-desc">Relevância % Decrescente</option>
                <option value="percentage-asc">Relevância % Crescente</option>
            </select>
            <button onclick="exportCSV()" class="btn btn-success ms-3">
                <i class="fas fa-download me-2"></i>Exportar CSV
            </button>
        </div>

        <!-- Tabela Simplificada -->
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="statisticsTable">
                <thead class="table-dark">
                    <tr>
                        <th>Qtd País</th>
                        <th>% País</th>
                        <th>País</th>
                        <th>Qtd Estado</th>
                        <th>% Estado</th>
                        <th>Estado</th>
                        <th>Qtd Cidade</th>
                        <th>% Cidade</th>
                        <th>Cidade</th>
                    </tr>
                </thead>
                <tbody id="statisticsTableBody">
                    <th:block th:each="pais : ${estatisticasPaises}">
                        <th:block th:each="estado : ${pais.subNiveis}">
                            <th:block th:each="cidade : ${estado.subNiveis}">
                                <tr>
                                    <td th:text="${pais.quantidade}">3</td>
                                    <td th:text="${pais.percentual} + '%'">75.0%</td>
                                    <td th:text="${pais.nome}">Brasil</td>
                                    <td th:text="${estado.quantidade}">2</td>
                                    <td th:text="${estado.percentual} + '%'">66.7%</td>
                                    <td th:text="${estado.nome}">SP</td>
                                    <td th:text="${cidade.quantidade}">1</td>
                                    <td th:text="${cidade.percentual} + '%'">25.0%</td>
                                    <td th:text="${cidade.nome}">São Paulo</td>
                                </tr>
                            </th:block>
                        </th:block>
                    </th:block>
                </tbody>
            </table>
        </div>

        <!-- Debug Info -->
        <div class="mt-4">
            <small class="text-muted">
                Países carregados: <span th:text="${#lists.size(estatisticasPaises ?: {})}">0</span>
            </small>
        </div>

        <!-- Botão Voltar -->
        <div class="mt-3">
            <a href="/administrador/lista-usuarios" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Voltar à Lista de Usuários
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function sortTable() {
            const table = document.getElementById('statisticsTable');
            const tbody = document.getElementById('statisticsTableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const sortOrder = document.getElementById('sortOrder').value;
            
            let sortedRows;
            
            if (sortOrder === 'percentage-desc') {
                sortedRows = rows.sort((a, b) => {
                    const percentA = parseFloat(a.cells[7].textContent.replace('%', ''));
                    const percentB = parseFloat(b.cells[7].textContent.replace('%', ''));
                    return percentB - percentA;
                });
            } else if (sortOrder === 'percentage-asc') {
                sortedRows = rows.sort((a, b) => {
                    const percentA = parseFloat(a.cells[7].textContent.replace('%', ''));
                    const percentB = parseFloat(b.cells[7].textContent.replace('%', ''));
                    return percentA - percentB;
                });
            } else {
                // Ordenação geográfica
                sortedRows = rows.sort((a, b) => {
                    const paisA = a.cells[2].textContent;
                    const paisB = b.cells[2].textContent;
                    const estadoA = a.cells[5].textContent;
                    const estadoB = b.cells[5].textContent;
                    const cidadeA = a.cells[8].textContent;
                    const cidadeB = b.cells[8].textContent;
                    
                    if (paisA !== paisB) return paisA.localeCompare(paisB);
                    if (estadoA !== estadoB) return estadoA.localeCompare(estadoB);
                    return cidadeA.localeCompare(cidadeB);
                });
            }
            
            tbody.innerHTML = '';
            sortedRows.forEach(row => tbody.appendChild(row));
        }
        
        function exportCSV() {
            const table = document.getElementById('statisticsTable');
            const rows = table.querySelectorAll('tbody tr');
            
            let csvContent = 'Qtd_Pais;Perc_Pais;Pais;Qtd_Estado;Perc_Estado;Estado;Qtd_Cidade;Perc_Cidade;Cidade\\n';
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                cells.forEach(cell => {
                    rowData.push(cell.textContent.trim());
                });
                csvContent += rowData.join(';') + '\\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'lista_estatistica_usuarios_' + new Date().toISOString().slice(0,10) + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('CSV exportado com sucesso!');
        }
    </script>
</body>
</html>
