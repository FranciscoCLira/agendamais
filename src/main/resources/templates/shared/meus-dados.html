<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Meus Dados</title>
    <link rel="stylesheet" th:href="@{/css/estilo.css}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <style>
      .form-container {
        max-width: 400px;
        margin: auto;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
      }
      .mensagem-erro {
        color: red;
        font-weight: bold;
        text-align: center;
        margin-bottom: 15px;
      }
      .mensagem-sucesso {
        color: green;
        font-weight: bold;
        text-align: center;
        margin-bottom: 15px;
      }
      .user-level-badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.8em;
        font-weight: bold;
        text-transform: uppercase;
      }
      .user-level-participante {
        background: #e3f2fd;
        color: #1976d2;
      }
      .user-level-autor {
        background: #f3e5f5;
        color: #7b1fa2;
      }
      .user-level-administrador {
        background: #fff3e0;
        color: #f57c00;
      }
      .user-level-super-usuario {
        background: #ffebee;
        color: #d32f2f;
      }
      .user-level-controle-total {
        background: #e8f5e8;
        color: #388e3c;
      }
    </style>
  </head>
  <body>
    <!-- CABECALHO PADRAO -->
    <div th:replace="fragments/layout_cabecalho :: cabecalho"></div>

    <main class="main-content">
      <div class="form-container">
        <h2><i class="fas fa-user-edit"></i> Meus Dados</h2>

        <!-- Mensagens -->
        <div th:if="${mensagemErro}" class="mensagem-erro">
          <i class="fas fa-exclamation-triangle"></i>
          <span th:text="${mensagemErro}"></span>
        </div>
        <div th:if="${mensagemSucesso}" class="mensagem-sucesso">
          <i class="fas fa-check-circle"></i>
          <span th:text="${mensagemSucesso}"></span>
        </div>

        <form
          th:action="@{/meus-dados}"
          method="post"
          th:object="${pessoa}"
          id="meusDadosForm"
        >
          <!-- DADOS PESSOAIS -->
          <fieldset>
            <legend><i class="fas fa-user"></i> Dados Pessoais</legend>

            <label for="nomePessoa">Nome Completo *:</label>
            <input
              type="text"
              id="nomePessoa"
              th:field="*{nomePessoa}"
              maxlength="100"
              required
              readonly
            />

            <label for="emailPessoa">E-mail *:</label>
            <input
              type="email"
              id="emailPessoa"
              th:field="*{emailPessoa}"
              maxlength="100"
              required
              readonly
            />

            <label for="telefonePessoa">Celular/Telefone:</label>
            <input
              type="text"
              id="telefonePessoa"
              th:field="*{celularPessoa}"
              maxlength="20"
              placeholder="+55-99-99999-9999"
              th:value="${celularPessoaFormatado}"
              onblur="formatarCelularInput(this)"
              readonly
            />

            <script>
              function formatarCelularInput(input) {
                let v = input.value.replace(/\D/g, "");
                if (v.length === 13) {
                  input.value = `+${v.substring(0, 2)}-${v.substring(
                    2,
                    4
                  )}-${v.substring(4, 9)}-${v.substring(9)}`;
                } else if (v.length === 11) {
                  input.value = `+55-${v.substring(0, 2)}-${v.substring(
                    2,
                    7
                  )}-${v.substring(7)}`;
                } else {
                  input.value = input.value; // mantém como está
                }
              }
            </script>

            <!-- Campos não disponíveis na entidade atual foram removidos -->

            <label for="curriculoPessoal">Currículo:</label>
            <textarea
              id="curriculoPessoal"
              th:field="*{curriculoPessoal}"
              rows="4"
              maxlength="1000"
              placeholder="Opcional..."
              readonly
            ></textarea>
          </fieldset>

          <!-- LOCALIZAÇÃO -->
          <fieldset>
            <legend><i class="fas fa-map-marker-alt"></i> Localização</legend>

            <label for="paisSelect">País *:</label>
            <select
              id="paisSelect"
              name="nomePaisPessoa"
              onchange="carregarEstados()"
              required
              disabled
            >
              <option value="">Selecione um país</option>
              <option
                th:each="pais : ${paises}"
                th:value="${pais.nomeLocal}"
                th:text="${pais.nomeLocal}"
                th:selected="${pais.nomeLocal == nomePaisPessoa}"
              ></option>
              <option value="Outro" th:selected="${nomePaisPessoa == 'Outro'}">
                Outro
              </option>
            </select>

            <div id="paisOutroDiv" style="display: none">
              <label for="paisOutro">Informe o País:</label>
              <input
                type="text"
                id="paisOutro"
                name="paisOutro"
                maxlength="100"
                readonly
              />
            </div>

            <label for="estadoSelect">Estado/Província *:</label>
            <select
              id="estadoSelect"
              name="nomeEstadoPessoa"
              onchange="carregarCidades()"
              required
              disabled
            >
              <option value="">Selecione um estado</option>
              <option
                th:each="estado : ${estados}"
                th:value="${estado.nomeLocal}"
                th:text="${estado.nomeLocal}"
                th:selected="${estado.nomeLocal == nomeEstadoPessoa}"
              ></option>
              <option
                value="Outro"
                th:selected="${nomeEstadoPessoa == 'Outro'}"
              >
                Outro
              </option>
            </select>

            <div id="estadoOutroDiv" style="display: none">
              <label for="estadoOutro">Informe o Estado:</label>
              <input
                type="text"
                id="estadoOutro"
                name="estadoOutro"
                maxlength="100"
                readonly
              />
            </div>

            <label for="cidadeSelect">Cidade *:</label>
            <select id="cidadeSelect" name="nomeCidadePessoa" required disabled>
              <option value="">Selecione uma cidade</option>
              <option
                th:each="cidade : ${cidades}"
                th:value="${cidade.nomeLocal}"
                th:text="${cidade.nomeLocal}"
                th:selected="${cidade.nomeLocal == nomeCidadePessoa}"
              ></option>
              <option
                value="Outro"
                th:selected="${nomeCidadePessoa == 'Outro'}"
              >
                Outro
              </option>
            </select>

            <div id="cidadeOutroDiv" style="display: none">
              <label for="cidadeOutro">Informe a Cidade:</label>
              <input
                type="text"
                id="cidadeOutro"
                name="cidadeOutro"
                maxlength="100"
                readonly
              />
            </div>
          </fieldset>

          <!-- OBSERVAÇÕES (visível para administradores e superiores) -->
          <fieldset
            th:if="${tipoUsuario == 'administrador' or tipoUsuario == 'super-usuario' or tipoUsuario == 'controle-total'}"
          >
            <legend><i class="fas fa-sticky-note"></i> Comentários</legend>
            <label for="comentarios">Comentários:</label>
            <textarea
              id="comentarios"
              th:field="*{comentarios}"
              rows="3"
              maxlength="500"
              readonly
            ></textarea>
          </fieldset>

          <div
            class="form-actions"
            style="text-align: center; margin-top: 20px"
          >
            <button type="button" id="editarBtn" onclick="toggleEditMode()">
              <i class="fas fa-edit"></i> Editar
            </button>
            <button type="submit" id="salvarBtn" style="display: none">
              <i class="fas fa-save"></i> Salvar Alterações
            </button>

            <!-- Botão de voltar adaptado ao tipo de usuário -->
            <div style="margin-top: 10px">
              <a
                th:href="${tipoUsuario == 'participante' ? '/participante' : 
                         tipoUsuario == 'autor' ? '/autor' :
                         tipoUsuario == 'administrador' ? '/administrador' :
                         tipoUsuario == 'super-usuario' ? '/superusuario' :
                         tipoUsuario == 'controle-total' ? '/controle-total' : '/participante'}"
              >
                <button type="button">
                  <i class="fas fa-arrow-left"></i> Voltar ao Menu
                </button>
              </a>
            </div>
          </div>
        </form>
      </div>
    </main>

    <script>
      // Funções JavaScript para gerenciar os selects de localização
      function carregarEstados() {
        const paisSelect = document.getElementById("paisSelect");
        const estadoSelect = document.getElementById("estadoSelect");
        const cidadeSelect = document.getElementById("cidadeSelect");
        const paisOutroDiv = document.getElementById("paisOutroDiv");

        if (paisSelect.value === "Outro") {
          paisOutroDiv.style.display = "block";
        } else {
          paisOutroDiv.style.display = "none";
        }

        // Limpa estados e cidades quando o país muda
        estadoSelect.innerHTML = '<option value="">Carregando...</option>';
        cidadeSelect.innerHTML =
          '<option value="">Selecione uma cidade</option>';

        if (paisSelect.value && paisSelect.value !== "Outro") {
          console.log("Carregando estados para:", paisSelect.value);
          fetch(
            `/api/locais/estados?paisNome=${encodeURIComponent(
              paisSelect.value
            )}`
          )
            .then((response) => {
              if (!response.ok) {
                throw new Error(
                  `HTTP ${response.status}: ${response.statusText}`
                );
              }
              return response.json();
            })
            .then((estados) => {
              console.log("Estados recebidos:", estados);
              estadoSelect.innerHTML =
                '<option value="">Selecione um estado</option>';
              estados.forEach((estado) => {
                const option = document.createElement("option");
                option.value = estado.nomeLocal;
                option.textContent = estado.nomeLocal;
                estadoSelect.appendChild(option);
              });
              estadoSelect.innerHTML += '<option value="Outro">Outro</option>';
            })
            .catch((error) => {
              console.error("Erro ao carregar estados:", error);
              estadoSelect.innerHTML =
                '<option value="">Erro ao carregar estados</option>';
            });
        } else {
          // Se não há país selecionado, limpa os selects
          estadoSelect.innerHTML =
            '<option value="">Selecione um estado</option>';
          cidadeSelect.innerHTML =
            '<option value="">Selecione uma cidade</option>';
        }
      }

      function carregarCidades() {
        const paisSelect = document.getElementById("paisSelect");
        const estadoSelect = document.getElementById("estadoSelect");
        const cidadeSelect = document.getElementById("cidadeSelect");
        const estadoOutroDiv = document.getElementById("estadoOutroDiv");

        if (estadoSelect.value === "Outro") {
          estadoOutroDiv.style.display = "block";
        } else {
          estadoOutroDiv.style.display = "none";
        }

        cidadeSelect.innerHTML = '<option value="">Carregando...</option>';

        if (
          estadoSelect.value &&
          estadoSelect.value !== "Outro" &&
          paisSelect.value &&
          paisSelect.value !== "Outro"
        ) {
          console.log("Carregando cidades para:", {
            pais: paisSelect.value,
            estado: estadoSelect.value,
          });

          fetch(
            `/api/locais/cidades?paisNome=${encodeURIComponent(
              paisSelect.value
            )}&estadoNome=${encodeURIComponent(estadoSelect.value)}`
          )
            .then((response) => {
              if (!response.ok) {
                throw new Error(
                  `HTTP ${response.status}: ${response.statusText}`
                );
              }
              return response.json();
            })
            .then((cidades) => {
              console.log("Cidades recebidas:", cidades);
              cidadeSelect.innerHTML =
                '<option value="">Selecione uma cidade</option>';
              cidades.forEach((cidade) => {
                const option = document.createElement("option");
                option.value = cidade.nomeLocal;
                option.textContent = cidade.nomeLocal;
                cidadeSelect.appendChild(option);
              });
              cidadeSelect.innerHTML += '<option value="Outro">Outro</option>';
            })
            .catch((error) => {
              console.error("Erro ao carregar cidades:", error);
              console.error("Detalhes do erro:", {
                pais: paisSelect.value,
                estado: estadoSelect.value,
                url: `/api/locais/cidades?paisNome=${encodeURIComponent(
                  paisSelect.value
                )}&estadoNome=${encodeURIComponent(estadoSelect.value)}`,
              });
              cidadeSelect.innerHTML =
                '<option value="">Erro ao carregar cidades</option>';
            });
        } else {
          // Se não há estado/país válido selecionado, limpa o select de cidades
          cidadeSelect.innerHTML =
            '<option value="">Selecione uma cidade</option>';
        }
      }

      // Gerencia campos "Outro"
      document
        .getElementById("cidadeSelect")
        .addEventListener("change", function () {
          const cidadeOutroDiv = document.getElementById("cidadeOutroDiv");
          if (this.value === "Outro") {
            cidadeOutroDiv.style.display = "block";
          } else {
            cidadeOutroDiv.style.display = "none";
          }
        });

      // Inicialização ao carregar a página
      document.addEventListener("DOMContentLoaded", function () {
        // Mostra campos "Outro" se necessário
        if (document.getElementById("paisSelect").value === "Outro") {
          document.getElementById("paisOutroDiv").style.display = "block";
        }
        if (document.getElementById("estadoSelect").value === "Outro") {
          document.getElementById("estadoOutroDiv").style.display = "block";
        }
        if (document.getElementById("cidadeSelect").value === "Outro") {
          document.getElementById("cidadeOutroDiv").style.display = "block";
        }
      });

      // Função para alternar entre modo de visualização e edição
      function toggleEditMode() {
        const editarBtn = document.getElementById("editarBtn");
        const salvarBtn = document.getElementById("salvarBtn");
        const form = document.getElementById("meusDadosForm");

        // Todos os campos de input e textarea
        const inputs = form.querySelectorAll("input, textarea, select");

        if (editarBtn.style.display !== "none") {
          // Modo EDIÇÃO: habilita campos e mostra botão salvar
          inputs.forEach((input) => {
            input.removeAttribute("readonly");
            input.removeAttribute("disabled");
          });

          editarBtn.style.display = "none";
          salvarBtn.style.display = "inline-block";

          // Adiciona classe para indicar modo de edição
          form.classList.add("editing");
        } else {
          // Modo VISUALIZAÇÃO: desabilita campos e mostra botão editar
          inputs.forEach((input) => {
            if (input.tagName.toLowerCase() === "select") {
              input.setAttribute("disabled", "disabled");
            } else {
              input.setAttribute("readonly", "readonly");
            }
          });

          editarBtn.style.display = "inline-block";
          salvarBtn.style.display = "none";

          // Remove classe de modo de edição
          form.classList.remove("editing");
        }
      }
    </script>

    <style>
      /* Estilos para campos readonly */
      input[readonly],
      textarea[readonly],
      select[disabled] {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        color: #6c757d;
        cursor: not-allowed;
      }

      /* Destacar quando em modo de edição */
      .editing input:not([readonly]),
      .editing textarea:not([readonly]),
      .editing select:not([disabled]) {
        background-color: #fff;
        border: 2px solid #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      }

      #editarBtn {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
      }

      #editarBtn:hover {
        background: #218838;
      }

      #salvarBtn {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
      }

      #salvarBtn:hover {
        background: #0056b3;
      }
    </style>
  </body>
</html>
