<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Cadastro - Informações Complementares</title>
    <link rel="stylesheet" th:href="@{/css/estilo.css}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <script src="/js/local-form.js"></script>
    <style>
      .form-container {
        max-width: 400px;
        margin: auto;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <header class="cabecalho">
      <div class="titulo">
        <h1>Agenda Mais</h1>
        <h3>Agendando tudo e mais</h3>
      </div>

      <div class="logo-central">
        <i class="fas fa-moon"></i>
      </div>

      <!-- Não mostrar informações de usuário durante cadastro -->
    </header>

    <div class="form-container">
      <h2>Informações Complementares</h2>

      <div style="text-align: center; margin-bottom: 10px">
        <strong
          th:if="${username}"
          th:text="'Usuário: ' + ${username}"
          class="mensagem-sucesso"
        ></strong>
      </div>

      <p
        th:if="${mensagemErro}"
        th:utext="${mensagemErro}"
        class="mensagem-erro"
      ></p>
      <p
        th:if="${mensagemSucesso}"
        th:text="${mensagemSucesso}"
        class="mensagem-sucesso"
      ></p>

      <form th:action="@{/cadastro-pessoa}" th:object="${pessoa}" method="post">
        <label>Nome:</label>
        <input type="text" th:field="*{nomePessoa}" maxlength="80" required />

        <label>Email:</label>
        <input type="email" th:field="*{emailPessoa}" required />

        <label>Celular: (Ex. +55-99-99999-9999)</label>
        <input
          type="text"
          th:field="*{celularPessoa}"
          required
          placeholder="+55-99-99999-9999"
          th:value="${celularPessoaFormatado}"
          onblur="formatarCelularInput(this)"
        />

<script>
function formatarCelularInput(input) {
  let v = input.value.replace(/\D/g, '');
  if (v.length === 13) {
    input.value = `+${v.substring(0,2)}-${v.substring(2,4)}-${v.substring(4,9)}-${v.substring(9)}`;
  } else if (v.length === 11) {
    input.value = `+55-${v.substring(0,2)}-${v.substring(2,7)}-${v.substring(7)}`;
  } else {
    input.value = input.value;
  }
}
</script>

        <!-- País -->
        <label>País:</label>
        <select
          id="paisSelect"
          name="nomePaisPessoa"
          onchange="paisChange(event)"
          required
        >
          <option value="">Selecione o país</option>
          <option
            th:each="pais : ${paises}"
            th:value="${pais.nomeLocal}"
            th:text="${pais.nomeLocal}"
            th:selected="${#strings.equalsIgnoreCase(pais.nomeLocal, pessoa.nomePais)}"
          ></option>
          <option value="Outro">Outro</option>
        </select>
        <input
          type="text"
          id="paisOutro"
          name="paisOutro"
          class="hidden"
          placeholder="Informe o País"
        />

        <!-- Estado -->
        <label>Estado:</label>
        <select
          id="estadoSelect"
          name="nomeEstadoPessoa"
          onchange="estadoChange(event)"
          required
        >
          <option value="">Selecione</option>
          <option
            th:each="estado : ${estados}"
            th:value="${estado.nomeLocal}"
            th:text="${estado.nomeLocal}"
            th:selected="${#strings.equalsIgnoreCase(estado.nomeLocal, pessoa.nomeEstado)}"
          ></option>
          <option value="Outro">Outro</option>
        </select>
        <input
          type="text"
          id="estadoOutro"
          name="estadoOutro"
          class="hidden"
          placeholder="Informe o Estado"
        />

        <!-- Cidade -->
        <label>Cidade:</label>
        <input
          type="text"
          id="cidade"
          name="nomeCidadePessoa"
          list="listaCidades"
          th:value="${pessoa.nomeCidade}"
          required
          autocomplete="off"
          placeholder="Digite o nome da cidade ou 'Outro' para cadastrar nova"
        />
        <datalist id="listaCidades">
          <!-- Cidades são carregadas dinamicamente via JavaScript -->
        </datalist>
        <input
          type="text"
          id="cidadeOutro"
          name="cidadeOutro"
          class="hidden"
          placeholder="Informe a Cidade"
        />

        <label>Currículo:</label>
        <textarea
          th:field="*{curriculoPessoal}"
          placeholder="Opcional..."
        ></textarea>

        <label>Comentários:</label>
        <textarea
          th:field="*{comentarios}"
          placeholder="Como chegou até aqui? Outros..."
        ></textarea>

        <div style="text-align: center; margin-top: 20px">
          <button type="submit">Confirmar Cadastro</button>
          <a href="/acesso"><button type="button">Voltar ao Login</button></a>
        </div>
      </form>
    </div>

    <script>
      document.querySelector("form").onsubmit = function (evt) {
        if (!confirm("Confirma o cadastro?")) {
          evt.preventDefault();
          return false;
        }

        // Processa campos "Outro" antes do envio (igual ao meus-dados.html)
        const paisSelect = document.getElementById("paisSelect");
        const estadoSelect = document.getElementById("estadoSelect");

        // Se país é "Outro", garante que o estado seja "Outro"
        if (paisSelect && paisSelect.value === "Outro") {
          if (estadoSelect) {
            estadoSelect.value = "Outro";
          }
          console.log(
            "Formulário enviado: País=Outro, Estado definido como Outro"
          );
        }

        return true;
      };
    </script>

    <!-- Script de gerenciamento de país/estado/cidade -->
    <script src="/js/local-form.js"></script>
  </body>
</html>
