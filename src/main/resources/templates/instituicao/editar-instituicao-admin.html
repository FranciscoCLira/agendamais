<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Editar Instituição</title>
    <link rel="stylesheet" th:href="@{/css/estilo.css}" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
  </head>
  <body>
    <div th:replace="fragments/layout_cabecalho :: cabecalho"></div>
    <div class="container mt-4">
      <h2>Editar Dados da Instituição</h2>
      <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
      <div
        th:if="${success}"
        class="alert alert-success"
        th:text="${success}"
      ></div>
      <form
        th:action="@{/administrador/instituicao/editar}"
        th:object="${instituicao}"
        method="post"
        onsubmit="return confirmPasswordClear()"
      >
        <input type="hidden" th:field="*{id}" />
        <div class="mb-3" style="width: 60%">
          <label for="emailInstituicao" class="form-label"
            >E-mail da Instituição</label
          >
          <input
            type="email"
            class="form-control"
            id="emailInstituicao"
            th:field="*{emailInstituicao}"
            required
            th:disabled="${instituicao.situacaoInstituicao == 'I'}"
          />
        </div>
        <div class="mb-3" style="width: 25%">
          <label for="situacaoInstituicao" class="form-label">Situação</label>
          <select
            class="form-select"
            id="situacaoInstituicao"
            th:field="*{situacaoInstituicao}"
            th:disabled="${instituicao.situacaoInstituicao == 'I'}"
          >
            <option value="A">Ativa</option>
            <option value="B">Bloqueada</option>
          </select>
        </div>

        <!-- SMTP Configuration Section -->
        <div class="card mb-3">
          <div
            class="card-header bg-light"
            style="cursor: pointer"
            data-bs-toggle="collapse"
            data-bs-target="#smtpConfig"
          >
            <i class="bi bi-envelope"></i> Configuração SMTP (Opcional - para
            envio de e-mails)
          </div>
          <div id="smtpConfig" class="collapse show">
            <div class="card-body">
              <div class="alert alert-info small">
                <strong>Configuração de servidor de e-mail:</strong> Configure
                estas opções para enviar e-mails usando o servidor SMTP desta
                instituição. Deixe em branco para usar as configurações padrão
                do sistema.
                <br />
                <strong>Dica:</strong> Porta 587 = STARTTLS (recomendado para
                Gmail) | Porta 465 = SSL/TLS
              </div>

              <div class="row">
                <div class="col-md-8 mb-3">
                  <label for="smtpHost" class="form-label"
                    >Servidor SMTP (Host)</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="smtpHost"
                    th:field="*{smtpHost}"
                    placeholder="Ex: smtp.gmail.com"
                    th:disabled="${instituicao.situacaoInstituicao == 'I'}"
                  />
                </div>
                <div class="col-md-4 mb-3">
                  <label for="smtpPort" class="form-label">Porta</label>
                  <input
                    type="number"
                    class="form-control"
                    id="smtpPort"
                    th:field="*{smtpPort}"
                    placeholder="587"
                    min="1"
                    max="65535"
                    th:disabled="${instituicao.situacaoInstituicao == 'I'}"
                  />
                </div>
              </div>

              <div class="mb-3">
                <label for="smtpUsername" class="form-label"
                  >Usuário SMTP</label
                >
                <div class="form-check mb-2">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="useSameEmail"
                    onchange="toggleSmtpUsername()"
                    checked
                  />
                  <label class="form-check-label" for="useSameEmail">
                    Usar o mesmo e-mail da instituição
                  </label>
                </div>
                <input
                  type="text"
                  class="form-control"
                  id="smtpUsername"
                  th:field="*{smtpUsername}"
                  th:value="${instituicao.smtpUsername != null and !#strings.isEmpty(instituicao.smtpUsername) ? instituicao.smtpUsername : instituicao.emailInstituicao}"
                  placeholder="Ex: seu-email@gmail.com"
                  th:disabled="${instituicao.situacaoInstituicao == 'I'}"
                  readonly
                />
              </div>

              <div class="mb-3">
                <label for="smtpPassword" class="form-label">Senha SMTP</label>
                <div class="input-group">
                  <input
                    type="password"
                    class="form-control"
                    id="smtpPassword"
                    th:field="*{smtpPassword}"
                    th:placeholder="${instituicao.smtpPassword != null ? '****** (Senha configurada)' : 'Senha ou App Password'}"
                    th:disabled="${instituicao.situacaoInstituicao == 'I'}"
                  />
                  <button
                    class="btn btn-outline-secondary"
                    type="button"
                    onclick="togglePasswordVisibility('smtpPassword')"
                  >
                    <i class="bi bi-eye" id="smtpPassword-icon"></i>
                  </button>
                </div>
                <div class="form-text">
                  Para Gmail, use um
                  <a
                    href="https://myaccount.google.com/apppasswords"
                    target="_blank"
                    >App Password</a
                  >
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Tipo de Conexão</label>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="smtpSsl"
                    id="smtpSslFalse"
                    th:field="*{smtpSsl}"
                    value="false"
                    th:disabled="${instituicao.situacaoInstituicao == 'I'}"
                  />
                  <label class="form-check-label" for="smtpSslFalse">
                    STARTTLS (Porta 587 - Recomendado)
                  </label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="smtpSsl"
                    id="smtpSslTrue"
                    th:field="*{smtpSsl}"
                    value="true"
                    th:disabled="${instituicao.situacaoInstituicao == 'I'}"
                  />
                  <label class="form-check-label" for="smtpSslTrue">
                    SSL/TLS (Porta 465)
                  </label>
                </div>
              </div>

              <div class="mb-3">
                <label for="modoEnvioEmail" class="form-label"
                  >Modo de Envio do Email</label
                >
                <select
                  class="form-select"
                  id="modoEnvioEmail"
                  th:field="*{modoEnvioEmail}"
                  th:disabled="${instituicao.situacaoInstituicao == 'I'}"
                >
                  <option value="">-- Selecione --</option>
                  <option value="1">Online (Envio direto)</option>
                  <option value="2">
                    Offline (Processamento em batch/fila)
                  </option>
                </select>
                <div class="form-text">
                  <strong>Objetivo:</strong> Parametriza diferentes mensagens no
                  rodapé do email<br />
                  <strong>Online:</strong> Disparo imediato com mensagem
                  padrão<br />
                  <strong>Offline:</strong> Processamento em segundo plano com
                  mensagem adaptada
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex gap-2">
          <button
            type="submit"
            class="btn btn-primary"
            th:disabled="${instituicao.situacaoInstituicao == 'I'}"
          >
            Salvar
          </button>
          <a th:href="@{/administrador}" class="btn btn-secondary">Voltar</a>
        </div>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function togglePasswordVisibility(fieldId) {
        const field = document.getElementById(fieldId);
        const icon = document.getElementById(fieldId + "-icon");
        if (field.type === "password") {
          field.type = "text";
          icon.classList.remove("bi-eye");
          icon.classList.add("bi-eye-slash");
        } else {
          field.type = "password";
          icon.classList.remove("bi-eye-slash");
          icon.classList.add("bi-eye");
        }
      }

      function toggleSmtpUsername() {
        const checkbox = document.getElementById("useSameEmail");
        const smtpUsername = document.getElementById("smtpUsername");
        const emailInstituicao = document.getElementById("emailInstituicao");

        if (checkbox.checked) {
          smtpUsername.value = emailInstituicao.value;
          smtpUsername.readOnly = true;
        } else {
          smtpUsername.readOnly = false;
          smtpUsername.focus();
        }
      }

      function confirmPasswordClear() {
        const passwordField = document.getElementById("smtpPassword");
        const hasExistingPassword =
          passwordField.placeholder.includes("configurada");
        const isPasswordEmpty =
          !passwordField.value || passwordField.value.trim() === "";

        // If there's an existing password and user left field empty, confirm
        if (hasExistingPassword && isPasswordEmpty) {
          return confirm(
            "Aten\u00e7\u00e3o: O campo 'Senha SMTP' est\u00e1 vazio.\n\n" +
              "Deixar vazio = manter senha atual configurada\n" +
              "Deseja continuar?"
          );
        }
        return true;
      }

      // Sync email when institution email changes
      document.addEventListener("DOMContentLoaded", function () {
        const emailInstituicao = document.getElementById("emailInstituicao");
        const smtpUsername = document.getElementById("smtpUsername");
        const checkbox = document.getElementById("useSameEmail");

        // Initialize: only check the box if smtpUsername already has the same value as emailInstituicao
        if (
          emailInstituicao.value &&
          smtpUsername.value &&
          smtpUsername.value === emailInstituicao.value
        ) {
          checkbox.checked = true;
          smtpUsername.readOnly = true;
        } else {
          // If different or empty, leave unchecked and editable
          checkbox.checked = false;
          smtpUsername.readOnly = false;
        }

        // Quando alterar o email da instituição, atualiza o SMTP username se checkbox marcado
        emailInstituicao.addEventListener("input", function () {
          if (checkbox.checked) {
            smtpUsername.value = emailInstituicao.value;
          }
        });
      });
    </script>
  </body>
</html>
