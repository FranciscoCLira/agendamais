<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title
      th:text="${instituicao.id != null} ? 'Editar Instituição' : 'Nova Instituição'"
    ></title>
    <link rel="stylesheet" th:href="@{/css/estilo.css}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
  </head>
  <body>
    <div th:replace="~{fragments/layout_cabecalho :: cabecalho}"></div>
    <main class="main-content">
      <div
        style="
          max-width: 600px;
          margin: 40px auto;
          background: #fff;
          border-radius: 12px;
          box-shadow: 0 2px 12px #0001;
          padding: 32px;
        "
      >
        <h2
          style="text-align: center; margin-bottom: 28px"
          th:text="${instituicao.id != null} ? 'Editar Instituição' : 'Nova Instituição'"
        ></h2>
        <form
          th:action="@{/gerenciar-instituicoes/salvar}"
          th:object="${instituicao}"
          method="post"
        >
          <input type="hidden" th:field="*{id}" />
          <div style="margin-bottom: 18px">
            <label
              for="nomeInstituicao"
              style="display: block; font-weight: bold"
              >Nome:</label
            >
            <input
              type="text"
              id="nomeInstituicao"
              th:field="*{nomeInstituicao}"
              required
              style="
                width: 100%;
                padding: 8px;
                border-radius: 6px;
                border: 1px solid #ccc;
              "
            />
          </div>
          <div style="margin-bottom: 18px">
            <label
              for="emailInstituicao"
              style="display: block; font-weight: bold"
              >Email:</label
            >
            <input
              type="email"
              id="emailInstituicao"
              th:field="*{emailInstituicao}"
              required
              style="
                width: 100%;
                padding: 8px;
                border-radius: 6px;
                border: 1px solid #ccc;
              "
            />
          </div>
          <div style="margin-bottom: 24px">
            <label
              for="situacaoInstituicao"
              style="display: block; font-weight: bold"
              >Situação:</label
            >
            <select
              id="situacaoInstituicao"
              th:field="*{situacaoInstituicao}"
              style="
                width: 100%;
                padding: 8px;
                border-radius: 6px;
                border: 1px solid #ccc;
              "
            >
              <option value="A">Ativa</option>
              <option value="B">Bloqueada</option>
              <option value="I">Inativa</option>
            </select>
          </div>

          <!-- SMTP Configuration Section -->
          <div
            style="
              margin-bottom: 24px;
              border: 1px solid #ddd;
              border-radius: 8px;
              overflow: hidden;
            "
          >
            <div
              style="
                background: #f8f9fa;
                padding: 12px 16px;
                font-weight: bold;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
              "
              onclick="document.getElementById('smtpConfig').classList.toggle('hidden')"
            >
              <i class="fas fa-envelope"></i>
              <span
                >Configuração SMTP (Opcional - para envio de e-mails)</span
              >
            </div>
            <div id="smtpConfig" class="hidden" style="padding: 16px">
              <div
                style="
                  background: #d1ecf1;
                  border: 1px solid #bee5eb;
                  border-radius: 6px;
                  padding: 12px;
                  margin-bottom: 16px;
                  font-size: 14px;
                  color: #0c5460;
                "
              >
                <strong>Configuração de servidor de e-mail:</strong> Configure
                estas opções para enviar e-mails usando o servidor SMTP desta
                instituição. Deixe em branco para usar as configurações padrão
                do sistema.
                <br />
                <strong>Dica:</strong> Porta 587 = STARTTLS (recomendado para
                Gmail) | Porta 465 = SSL/TLS
              </div>

              <div style="margin-bottom: 16px">
                <label for="smtpHost" style="display: block; font-weight: bold"
                  >Servidor SMTP (Host):</label
                >
                <input
                  type="text"
                  id="smtpHost"
                  th:field="*{smtpHost}"
                  placeholder="Ex: smtp.gmail.com"
                  style="
                    width: 100%;
                    padding: 8px;
                    border-radius: 6px;
                    border: 1px solid #ccc;
                  "
                />
              </div>

              <div style="margin-bottom: 16px">
                <label for="smtpPort" style="display: block; font-weight: bold"
                  >Porta SMTP:</label
                >
                <input
                  type="number"
                  id="smtpPort"
                  th:field="*{smtpPort}"
                  placeholder="587"
                  min="1"
                  max="65535"
                  style="
                    width: 150px;
                    padding: 8px;
                    border-radius: 6px;
                    border: 1px solid #ccc;
                  "
                />
              </div>

              <div style="margin-bottom: 16px">
                <label
                  for="smtpUsername"
                  style="display: block; font-weight: bold"
                  >Usuário SMTP:</label
                >
                <div style="margin-bottom: 8px">
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer">
                    <input
                      type="checkbox"
                      id="useSameEmail"
                      onchange="toggleSmtpUsername()"
                      checked
                    />
                    <span>Usar o mesmo e-mail da instituição</span>
                  </label>
                </div>
                <input
                  type="text"
                  id="smtpUsername"
                  th:field="*{smtpUsername}"
                  placeholder="Ex: seu-email@gmail.com"
                  readonly
                  style="
                    width: 100%;
                    padding: 8px;
                    border-radius: 6px;
                    border: 1px solid #ccc;
                    background-color: #f8f9fa;
                  "
                />
              </div>

              <div style="margin-bottom: 16px">
                <label
                  for="smtpPassword"
                  style="display: block; font-weight: bold"
                  >Senha SMTP:</label
                >
                <div style="display: flex; gap: 8px">
                  <input
                    type="password"
                    id="smtpPassword"
                    th:field="*{smtpPassword}"
                    placeholder="Senha ou App Password"
                    style="
                      flex: 1;
                      padding: 8px;
                      border-radius: 6px;
                      border: 1px solid #ccc;
                    "
                  />
                  <button
                    type="button"
                    onclick="togglePasswordVisibility('smtpPassword')"
                    style="
                      padding: 8px 16px;
                      border: 1px solid #ccc;
                      border-radius: 6px;
                      background: #fff;
                      cursor: pointer;
                    "
                  >
                    <i class="fas fa-eye" id="smtpPassword-icon"></i>
                  </button>
                </div>
                <small style="color: #666; display: block; margin-top: 4px"
                  >Para Gmail, use um
                  <a
                    href="https://myaccount.google.com/apppasswords"
                    target="_blank"
                    >App Password</a
                  ></small
                >
              </div>

              <div style="margin-bottom: 16px">
                <label style="display: block; font-weight: bold; margin-bottom: 8px"
                  >Tipo de Conexão:</label
                >
                <div style="display: flex; flex-direction: column; gap: 8px">
                  <label style="display: flex; align-items: center; gap: 8px">
                    <input
                      type="radio"
                      name="smtpSsl"
                      th:field="*{smtpSsl}"
                      value="false"
                    />
                    STARTTLS (Porta 587 - Recomendado)
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px">
                    <input
                      type="radio"
                      name="smtpSsl"
                      th:field="*{smtpSsl}"
                      value="true"
                    />
                    SSL/TLS (Porta 465)
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div style="display: flex; justify-content: flex-end; gap: 12px">
            <button
              type="submit"
              class="btn btn-primary"
              style="
                background: #4f2683;
                color: #fff;
                padding: 8px 18px;
                border-radius: 6px;
                font-weight: bold;
                border: none;
              "
            >
              Salvar
            </button>
            <a
              th:href="@{/gerenciar-instituicoes}"
              class="btn btn-secondary"
              style="
                background: #eee;
                color: #4f2683;
                padding: 8px 18px;
                border-radius: 6px;
                font-weight: bold;
                text-decoration: none;
                border: 1px solid #4f2683;
              "
              >Voltar</a
            >
          </div>
        </form>
      </div>
    </main>

    <style>
      .hidden {
        display: none !important;
      }
    </style>

    <script>
      function togglePasswordVisibility(fieldId) {
        const field = document.getElementById(fieldId);
        const icon = document.getElementById(fieldId + "-icon");
        if (field.type === "password") {
          field.type = "text";
          icon.classList.remove("fa-eye");
          icon.classList.add("fa-eye-slash");
        } else {
          field.type = "password";
          icon.classList.remove("fa-eye-slash");
          icon.classList.add("fa-eye");
        }
      }

      function toggleSmtpUsername() {
        const checkbox = document.getElementById("useSameEmail");
        const smtpUsername = document.getElementById("smtpUsername");
        const emailInstituicao = document.getElementById("emailInstituicao");

        if (checkbox.checked) {
          smtpUsername.value = emailInstituicao.value;
          smtpUsername.readOnly = true;
          smtpUsername.style.backgroundColor = "#f8f9fa";
        } else {
          smtpUsername.readOnly = false;
          smtpUsername.style.backgroundColor = "#fff";
          smtpUsername.focus();
        }
      }

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", function () {
        const emailInstituicao = document.getElementById("emailInstituicao");
        const smtpUsername = document.getElementById("smtpUsername");
        const checkbox = document.getElementById("useSameEmail");

        // Initialize: if both emails are the same, check the box
        if (emailInstituicao && smtpUsername) {
          if (emailInstituicao.value && smtpUsername.value === emailInstituicao.value) {
            checkbox.checked = true;
            smtpUsername.readOnly = true;
            smtpUsername.style.backgroundColor = "#f8f9fa";
          } else if (smtpUsername.value) {
            checkbox.checked = false;
            smtpUsername.readOnly = false;
            smtpUsername.style.backgroundColor = "#fff";
          }

          // Sync email when institution email changes
          emailInstituicao.addEventListener("input", function () {
            if (checkbox.checked) {
              smtpUsername.value = emailInstituicao.value;
            }
          });
        }
      });
    </script>
  </body>
</html>
