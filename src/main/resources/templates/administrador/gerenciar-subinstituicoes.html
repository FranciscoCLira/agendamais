<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Gerenciar Sub-Instituições</title>
    <link rel="stylesheet" th:href="@{/css/estilo.css}" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <style>
      /* Aggressive CSS override for minimal column gap */
      .table {
        border-spacing: 0 !important;
        border-collapse: collapse !important;
        table-layout: fixed !important;
        width: 100% !important;
      }
      .table th,
      .table td {
        padding: 0 !important;
        margin: 0 !important;
        border: none !important;
        min-width: 0 !important;
        width: auto !important;
        font-size: 1rem;
      }
      .table th:first-child,
      .table td:first-child {
        padding-left: 8px !important;
      }
      .table th + th,
      .table td + td {
        padding-left: 0 !important;
      }
      /* Light blue header background */
      .table thead th {
        background-color: #e3f2fd !important;
      }
    </style>
  </head>
  <body>
    <div th:replace="~{fragments/layout_cabecalho :: cabecalho}"></div>
    <div class="container mt-4">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="/administrador"
              ><i class="fas fa-home"></i> Administrador</a
            >
          </li>
          <li class="breadcrumb-item active" aria-current="page">
            <i class="fas fa-sitemap"></i> Gerenciar Sub-Instituições
          </li>
        </ol>
      </nav>
      <div class="row mb-2">
        <div class="col-12">
          <h2>
            <i class="fas fa-sitemap me-2 text-primary"></i> Gerenciar
            Sub-Instituições
          </h2>
          <p class="text-muted">
            Administre as sub-instituições vinculadas à sua instituição
          </p>
        </div>
        <script>
          document.addEventListener("DOMContentLoaded", function () {
            const filtroDataIni = document.getElementById("filtroDataIni");
            const filtroDataFim = document.getElementById("filtroDataFim");
            const filtroNomeSub = document.getElementById("filtroNomeSub");
            const filtroSituacao = document.getElementById("filtroSituacao");
            const filtroOrdenar = document.getElementById("filtroOrdenar");
            const filtroItensPorPagina = document.getElementById(
              "filtroItensPorPagina"
            );
            const linhas = Array.from(document.querySelectorAll("tbody tr"));
            let paginaAtual = 1;
            let linhasFiltradas = linhas;

            // Limpar filtros
            document.getElementById("btnLimparFiltros").onclick = function () {
              filtroDataIni.value = "";
              filtroDataFim.value = "";
              filtroNomeSub.value = "";
              filtroSituacao.value = "";
              filtroOrdenar.value = "dataDesc";
              filtrarTabela();
            };

            function filtrarTabela(keepPage = false) {
              const nomeBusca = filtroNomeSub.value.trim().toLowerCase();
              const sit = filtroSituacao.value;
              const dataIni = filtroDataIni.value;
              const dataFim = filtroDataFim.value;
              let filtradas = linhas.filter(function (linha) {
                const nome = linha
                  .querySelector("td:nth-child(2)")
                  .textContent.toLowerCase();
                const situacao = linha
                  .querySelector("td:nth-child(3) .badge")
                  .textContent.trim();
                const dataStr = linha
                  .querySelector("td:nth-child(1)")
                  .textContent.trim();
                let dataVal = null;
                if (/^\d{2}\/\d{2}\/\d{2}$/.test(dataStr)) {
                  const [d, m, y] = dataStr.split("/");
                  dataVal = new Date("20" + y, m - 1, d);
                }
                let matchData = true;
                if (dataIni && dataVal) {
                  const [di, mi, yi] = dataIni.split("/");
                  const ini = new Date(`20${yi}`, mi - 1, di);
                  matchData = dataVal >= ini;
                }
                if (dataFim && dataVal) {
                  const [df, mf, yf] = dataFim.split("/");
                  const fim = new Date(`20${yf}`, mf - 1, df);
                  matchData = matchData && dataVal <= fim;
                }
                // Partial match for any substring in nome
                const matchNome = !nomeBusca || nome.includes(nomeBusca);
                const matchSit = !sit || situacao === sit;
                return matchNome && matchSit && matchData;
              });
              // Ordenação
              console.log("Ordenar:", filtroOrdenar.value);
              if (
                filtroOrdenar.value === "dataDesc" ||
                filtroOrdenar.value === "dataAsc"
              ) {
                filtradas.sort((a, b) => {
                  const daStr = a
                    .querySelector("td:nth-child(1)")
                    .textContent.trim();
                  const dbStr = b
                    .querySelector("td:nth-child(1)")
                    .textContent.trim();
                  // Parse dd/MM/yy as yyyy-mm-dd
                  function parseDMY(str) {
                    const match = str.match(/^(\d{2})\/(\d{2})\/(\d{2})$/);
                    if (!match) return null;
                    const [_, d, m, y] = match;
                    return new Date(`20${y}-${m}-${d}`);
                  }
                  const da = parseDMY(daStr);
                  const db = parseDMY(dbStr);
                  if (!da || !db || isNaN(da.getTime()) || isNaN(db.getTime()))
                    return 0;
                  return filtroOrdenar.value === "dataDesc"
                    ? db.getTime() - da.getTime()
                    : da.getTime() - db.getTime();
                });
              } else if (filtroOrdenar.value === "nome") {
                filtradas.sort((a, b) => {
                  const nomeA = a
                    .querySelector("td:nth-child(2)")
                    .textContent.toLowerCase();
                  const nomeB = b
                    .querySelector("td:nth-child(2)")
                    .textContent.toLowerCase();
                  return nomeA.localeCompare(nomeB);
                });
              }
              // Force table update by reattaching sorted rows
              const tbody = document.querySelector("table tbody");
              filtradas.forEach((tr) => tbody.appendChild(tr));
              linhasFiltradas = filtradas;
              if (!keepPage) paginaAtual = 1;
              paginarTabela();
            }

            function paginarTabela() {
              const itensPorPagina = parseInt(filtroItensPorPagina.value);
              const totalPaginas = Math.max(
                1,
                Math.ceil(linhasFiltradas.length / itensPorPagina)
              );
              if (paginaAtual > totalPaginas) paginaAtual = 1;
              linhas.forEach((linha) => (linha.style.display = "none"));
              linhasFiltradas.forEach((linha, idx) => {
                if (
                  idx >= (paginaAtual - 1) * itensPorPagina &&
                  idx < paginaAtual * itensPorPagina
                ) {
                  linha.style.display = "";
                }
              });
              document.getElementById(
                "totalCount"
              ).textContent = `Total: ${linhasFiltradas.length} Sub-instituições`;
              const pagination = document.getElementById("pagination");
              pagination.innerHTML = "";
              if (totalPaginas > 1) {
                for (let i = 1; i <= totalPaginas; i++) {
                  const li = document.createElement("li");
                  li.className =
                    "page-item" + (i === paginaAtual ? " active" : "");
                  const a = document.createElement("a");
                  a.className = "page-link";
                  a.href = "#";
                  a.textContent = i;
                  a.addEventListener("click", function (e) {
                    e.preventDefault();
                    paginaAtual = i;
                    paginarTabela();
                  });
                  li.appendChild(a);
                  pagination.appendChild(li);
                }
              }
            }

            // Autocomplete for Buscar Sub-Instituições
            let autocompleteList = document.createElement("div");
            autocompleteList.setAttribute("id", "autocomplete-list");
            autocompleteList.setAttribute("class", "autocomplete-items");
            filtroNomeSub.parentNode.appendChild(autocompleteList);
            filtroNomeSub.addEventListener("input", function () {
              const val = this.value.toLowerCase();
              autocompleteList.innerHTML = "";
              if (!val) return;
              let matches = linhas
                .map(
                  (linha) => linha.querySelector("td:nth-child(2)").textContent
                )
                .filter((nome) => nome.toLowerCase().startsWith(val));
              matches = [...new Set(matches)];
              matches.forEach((nome) => {
                const item = document.createElement("div");
                item.textContent = nome;
                item.className = "autocomplete-item";
                item.tabIndex = 0;
                item.onclick = function () {
                  filtroNomeSub.value = nome;
                  autocompleteList.innerHTML = "";
                  filtrarTabela();
                };
                item.addEventListener("keydown", function (ev) {
                  if (ev.key === "Enter" || ev.key === "Tab") {
                    filtroNomeSub.value = nome;
                    autocompleteList.innerHTML = "";
                    filtrarTabela();
                    filtroNomeSub.focus();
                    ev.preventDefault();
                  }
                });
                autocompleteList.appendChild(item);
              });
            });
            document.addEventListener("click", function (e) {
              if (e.target !== filtroNomeSub) autocompleteList.innerHTML = "";
            });

            // Fix: Enter/Tab in input only filters by input value, never auto-selects dropdown
            filtroNomeSub.addEventListener("keydown", function (e) {
              if (e.key === "Enter" || e.key === "Tab") {
                // If a dropdown item is focused, select it
                const focused = document.activeElement;
                if (focused.classList.contains("autocomplete-item")) {
                  filtroNomeSub.value = focused.textContent;
                  autocompleteList.innerHTML = "";
                  filtrarTabela();
                  e.preventDefault();
                } else {
                  // Otherwise, just filter by input value and close dropdown
                  autocompleteList.innerHTML = "";
                  filtrarTabela();
                }
              }
            });

            [
              filtroDataIni,
              filtroDataFim,
              filtroNomeSub,
              filtroSituacao,
              filtroOrdenar,
              filtroItensPorPagina,
            ].forEach((el) => {
              el.addEventListener("input", filtrarTabela);
              el.addEventListener("change", filtrarTabela);
            });
            // Ensure Ordenar filter triggers sorting
            filtroOrdenar.addEventListener("change", function () {
              filtrarTabela();
            });
            filtroOrdenar.addEventListener("input", function () {
              filtrarTabela();
            });

            // Show all rows on initial load
            linhas.forEach((linha) => (linha.style.display = ""));
            filtrarTabela();
          });

          document
            .getElementById("formNovaSub")
            .addEventListener("submit", function (e) {
              e.preventDefault();
              const nome = document.getElementById("novaNome").value;
              const situacao = document.getElementById("novaSituacao").value;
              const tbody = document.querySelector("table tbody");
              const tr = document.createElement("tr");
              const now = new Date();
              const dataStr = now.toLocaleDateString("pt-BR").slice(0, 8);
              tr.innerHTML = `<td>${dataStr}</td><td>${nome}</td><td><span class=\"badge ${
                situacao === "A"
                  ? "bg-success"
                  : situacao === "I"
                  ? "bg-danger-subtle text-danger"
                  : "bg-danger"
              }\">${situacao}</span></td><td><button type='button' class='btn btn-sm btn-outline-primary me-1' title='Editar' onclick='editarSubInstituicao(\"new\")'><i class='fas fa-pencil-alt'></i></button><button type='button' class='btn btn-sm btn-outline-danger' title='Excluir' onclick='excluirSubInstituicao(\"new\")'><i class='fas fa-times'></i></button></td>`;
              tbody.appendChild(tr);
              linhas.push(tr);
              var modal = bootstrap.Modal.getInstance(
                document.getElementById("modalNovaSub")
              );
              modal.hide();
              e.target.reset();
              filtrarTabela(true);
            });

          // Funções dos ícones
          function editarSubInstituicao(id) {
            alert("Editar Sub-Instituição: " + id);
            // Aqui pode abrir modal ou redirecionar para página de edição
          }
          function excluirSubInstituicao(id) {
            if (confirm("Confirma exclusão da Sub-Instituição " + id + "?")) {
              alert("Excluindo Sub-Instituição: " + id);
              // Aqui pode chamar endpoint de exclusão
            }
          }
        </script>
      </div>
      <div class="d-flex justify-content-end mb-3">
        <div class="d-flex w-100 align-items-center mb-3">
          <span
            id="totalCount"
            class="fw-bold me-auto"
            style="align-self: center"
          ></span>
          <a
            href="#"
            class="btn btn-success ms-2"
            data-bs-toggle="modal"
            data-bs-target="#modalNovaSub"
          >
            <i class="fas fa-plus"></i> Nova Sub-Instituição
          </a>
        </div>
      </div>
      <!-- Filtros -->
      <form
        class="row mb-2"
        method="get"
        action="/administrador/subinstituicoes"
      >
        <!-- Filtros dinâmicos -->
        <div class="row mb-2">
          <div class="col-md-3">
            <label class="form-label mb-1">Ult.Atualiz: Início - Fim</label>
            <div class="d-flex">
              <input
                type="text"
                class="form-control me-1"
                id="filtroDataIni"
                placeholder="dd/mm/aa"
                maxlength="8"
              />
              <input
                type="text"
                class="form-control"
                id="filtroDataFim"
                placeholder="dd/mm/aa"
                maxlength="8"
              />
            </div>
          </div>
          <div class="col-md-3">
            <label class="form-label mb-1">Buscar Sub-Instituições</label>
            <input
              type="text"
              class="form-control"
              id="filtroNomeSub"
              placeholder="Digite para buscar..."
              autocomplete="off"
            />
          </div>
          <div class="col-md-2">
            <label class="form-label mb-1">Situação</label>
            <select class="form-select" id="filtroSituacao">
              <option value="">Todas</option>
              <option value="A">Ativa</option>
              <option value="I">Inativa</option>
              <option value="B">Bloqueada</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label mb-1">Ordenar</label>
            <select class="form-select" id="filtroOrdenar">
              <option value="dataDesc">Ult.Atualiz desc</option>
              <option value="dataAsc">Ult.Atualiz asc</option>
              <option value="nome">Sub.Instituição</option>
            </select>
          </div>
          <div class="col-md-1">
            <label class="form-label mb-1">Itens</label>
            <div class="d-flex align-items-center">
              <select
                class="form-select"
                id="filtroItensPorPagina"
                style="min-width: 80px; width: 100px"
              >
                <option value="10">10</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="200">200</option>
              </select>
              <button
                type="button"
                id="btnLimparFiltros"
                class="btn btn-outline-secondary ms-2"
              >
                Limpar
              </button>
            </div>
          </div>
        </div>
      </form>
      <div class="card mt-2">
        <div class="table-responsive">
          <table
            class="table table-hover mb-0"
            style="
              border-spacing: 0;
              border-collapse: separate;
              table-layout: fixed;
              width: 100%;
            "
          >
            <thead class="bg-light">
              <tr>
                <th style="padding-right: 1px">Ult.Atualiz</th>
                <th style="padding-left: 1px">Nome Sub.Instituição</th>
                <th style="padding-right: 1px">Sit.</th>
                <th style="padding-left: 1px; padding-right: 1px">Ações</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="sub : ${subinstituicoes}">
                <td
                  th:text="${#temporals.format(sub.dataUltimaAtualizacao, 'dd/MM/yy')}"
                  style="padding-right: 1px"
                >
                  01/01/25
                </td>
                <td
                  th:text="${sub.nomeSubInstituicao}"
                  style="padding-left: 1px"
                >
                  Nome Sub
                </td>
                <td style="padding-right: 1px">
                  <span th:switch="${sub.situacaoSubInstituicao}">
                    <span th:case="'A'" class="badge bg-success">A</span>
                    <span
                      th:case="'I'"
                      class="badge bg-danger-subtle text-danger"
                      >I</span
                    >
                    <span th:case="'B'" class="badge bg-danger">B</span>
                    <span
                      th:case="*"
                      class="badge bg-secondary"
                      th:text="${sub.situacaoSubInstituicao}"
                      >?</span
                    >
                  </span>
                </td>
                <td style="padding-left: 1px; padding-right: 1px">
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-primary me-1"
                    title="Editar"
                    onclick="editarSubInstituicao('[[${sub.id}]]')"
                  >
                    <i class="fas fa-pencil-alt"></i>
                  </button>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-danger"
                    title="Excluir"
                    onclick="editarSubInstituicao('[[${sub.id}]]')"
                  >
                    <i class="fas fa-times"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          <div class="d-flex justify-content-between align-items-center mt-2">
            <span id="totalCount" class="font-weight-bold"></span>
            <nav>
              <ul id="pagination" class="pagination mb-0"></ul>
            </nav>
          </div>
        </div>
        <!-- Modal Nova Sub-Instituição -->
        <div
          class="modal fade"
          id="modalNovaSub"
          tabindex="-1"
          aria-labelledby="modalNovaSubLabel"
          aria-hidden="true"
        >
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="modalNovaSubLabel">
                  Nova Sub-Instituição
                </h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <form
                id="formNovaSub"
                th:action="@{/administrador/subinstituicoes/nova}"
                th:object="${subInstituicao}"
                method="post"
                autocomplete="off"
              >
                <div class="modal-body">
                  <div class="mb-3">
                    <label for="novaNome" class="form-label">Nome</label>
                    <input
                      type="text"
                      class="form-control"
                      id="novaNome"
                      th:field="*{nomeSubInstituicao}"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label for="novaSituacao" class="form-label"
                      >Situação</label
                    >
                    <select
                      class="form-select"
                      id="novaSituacao"
                      th:field="*{situacaoSubInstituicao}"
                      required
                    >
                      <option value="A">Ativa</option>
                      <option value="I">Inativa</option>
                      <option value="B">Bloqueada</option>
                    </select>
                  </div>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    Cancelar
                  </button>
                  <button type="submit" class="btn btn-success">Salvar</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
