<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title
      th:text="${regiao.id == null ? 'Nova Região' : 'Editar Região'} + ' - Administração'"
    >
      Região - Administração
    </title>
    <link rel="stylesheet" th:href="@{/css/estilo.css}" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        background-color: #f5f5f5;
      }
      .container-form {
        background: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 0 10px #ddd;
        margin: 20px auto;
        max-width: 700px;
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        display: block;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.95rem;
      }
      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #4b0082;
        box-shadow: 0 0 5px rgba(75, 0, 130, 0.3);
      }
      .form-group small {
        color: #666;
        display: block;
        margin-top: 5px;
      }
      .cidades-container {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        background-color: #f9f9f9;
        max-height: 300px;
        overflow-y: auto;
      }
      .cidades-container label {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        font-weight: normal;
        cursor: pointer;
      }
      .cidades-container input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
        margin-bottom: 0;
        cursor: pointer;
      }
      .btn-salvar {
        background: #4b0082;
        color: #fff;
        border: none;
        padding: 10px 30px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        margin-right: 10px;
      }
      .btn-salvar:hover {
        background: #3d006b;
      }
      .btn-cancelar {
        background: #6c757d;
        color: #fff;
        border: none;
        padding: 10px 30px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
      }
      .btn-cancelar:hover {
        background: #5a6268;
      }
      .mensagem-erro {
        color: #721c24;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 20px;
      }
      .alert-info-formato {
        background-color: #d1ecf1;
        color: #0c5460;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 15px;
        border: 1px solid #bee5eb;
      }
      .botoes-grupo {
        display: flex;
        gap: 10px;
        margin-top: 30px;
      }
    </style>
  </head>
  <body>
    <div th:replace="fragments/layout_cabecalho :: cabecalho"></div>

    <div class="container-form">
      <h1 style="margin-bottom: 25px">
        <i class="fas fa-globe"></i>
        <span th:text="${regiao.id == null ? 'Nova Região' : 'Editar Região'}"
          >Região</span
        >
      </h1>

      <div th:if="${erro}" class="mensagem-erro">
        <i class="fas fa-exclamation-circle"></i>
        <span th:text="${erro}">Erro ao processar!</span>
      </div>

      <form
        method="POST"
        action="/administrador/regioes/salvar"
        th:object="${regiao}"
      >
        <input type="hidden" name="id" th:field="*{id}" />

        <!-- Bloco: Dados da Região -->
        <fieldset
          style="
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
          "
        >
          <legend style="font-weight: 600; color: #333">Dados da Região</legend>

          <div class="form-group">
            <label for="codRegiao">
              <i class="fas fa-barcode"></i> Código da Região
              <span style="color: red">*</span>
            </label>
            <input
              type="text"
              id="codRegiao"
              name="codRegiao"
              th:field="*{codRegiao}"
              maxlength="6"
              required
              placeholder="PPEENN"
            />
            <div class="alert-info-formato">
              <strong>Formato:</strong> PPEENN<br />
              <strong>Exemplo:</strong> BR SP 01<br />
              PP = Sigla do País (ISO 3166-1), EE = Sigla Estado, NN = Número
              região
            </div>
          </div>

          <div class="form-group">
            <label for="nomeRegiao">
              <i class="fas fa-heading"></i> Nome da Região
              <span style="color: red">*</span>
            </label>
            <input
              type="text"
              id="nomeRegiao"
              name="nomeRegiao"
              th:field="*{nomeRegiao}"
              maxlength="100"
              required
              placeholder="Ex: Região Metropolitana de SP"
            />
          </div>
        </fieldset>

        <!-- Bloco: Localização -->
        <fieldset
          style="
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
          "
        >
          <legend style="font-weight: 600; color: #333">Localização</legend>

          <div class="form-group">
            <label for="paisId">
              <i class="fas fa-flag"></i> País
              <span style="color: red">*</span>
            </label>
            <select
              id="paisId"
              name="paisId"
              required
              onchange="carregarEstados(true)"
            >
              <option value="">Selecione um País</option>
              <option
                th:each="pais : ${paises}"
                th:value="${pais.id}"
                th:text="${pais.nomeLocal}"
                th:selected="${regiao != null and regiao.pais != null and regiao.pais.id != null and regiao.pais.id == pais.id}"
              >
                País
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="estadoId">
              <i class="fas fa-map"></i> Estado
              <span style="color: red">*</span>
            </label>
            <select
              id="estadoId"
              name="estadoId"
              required
              th:attr="data-preloaded=${estados != null and !#lists.isEmpty(estados)}"
              onchange="carregarCidades(true)"
            >
              <option value="">Selecione um Estado</option>
              <option
                th:each="estado : ${estados}"
                th:value="${estado.id}"
                th:text="${estado.nomeLocal}"
                th:selected="${regiao != null and regiao.estado != null and regiao.estado.id != null and regiao.estado.id == estado.id}"
              >
                Estado
              </option>
            </select>
          </div>
        </fieldset>

        <!-- Bloco: Cidades -->
        <fieldset
          style="
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
          "
        >
          <legend style="font-weight: 600; color: #333">
            <i class="fas fa-city"></i> Cidades (Selecione uma ou mais)
          </legend>

          <div
            id="cidadesContainer"
            class="cidades-container"
            th:attr="data-preloaded=${cidades != null and !#lists.isEmpty(cidades)}"
          >
            <div th:if="${cidades != null and !#lists.isEmpty(cidades)}">
              <label th:each="cidade : ${cidades}">
                <input
                  type="checkbox"
                  name="cidadeIds"
                  th:value="${cidade.id}"
                  th:checked="${cidadeIdsSelecionadas != null and cidadeIdsSelecionadas.contains(cidade.id)}"
                />
                <span th:text="${cidade.nomeLocal}">Cidade</span>
              </label>
            </div>
            <p
              th:if="${cidades == null or #lists.isEmpty(cidades)}"
              style="color: #666; text-align: center; margin: 0"
            >
              Selecione um Estado para carregar as cidades
            </p>
          </div>
          <small style="color: #666; margin-top: 10px; display: block">
            <i class="fas fa-info-circle"></i> Uma região pode conter múltiplas
            cidades do mesmo estado
          </small>
        </fieldset>

        <!-- Botões de Ação -->
        <div class="botoes-grupo">
          <!-- CSRF token for Spring Security -->
          <input
            type="hidden"
            th:if="${_csrf != null}"
            th:name="${_csrf.parameterName}"
            th:value="${_csrf.token}"
          />
          <button type="submit" class="btn-salvar">
            <i class="fas fa-save"></i> Salvar
          </button>
          <a
            href="/administrador/regioes"
            class="btn-cancelar"
            style="
              text-decoration: none;
              display: inline-flex;
              align-items: center;
            "
          >
            <i class="fas fa-times"></i> Cancelar
          </a>
        </div>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
      // Dados globais para controle de estado
      let estadoSelecionado = null;
      let cidadesSelecionadas = /*[[${cidadeIdsSelecionadas}]]*/ [];
      if (!Array.isArray(cidadesSelecionadas)) {
        cidadesSelecionadas = [];
      }

      function registrarEventosCidades() {
        document
          .querySelectorAll('#cidadesContainer input[type="checkbox"]')
          .forEach((cb) => {
            cb.addEventListener("change", () => {
              const id = Number(cb.value);
              if (cb.checked) {
                if (!cidadesSelecionadas.includes(id)) {
                  cidadesSelecionadas.push(id);
                }
              } else {
                const idx = cidadesSelecionadas.indexOf(id);
                if (idx > -1) {
                  cidadesSelecionadas.splice(idx, 1);
                }
              }
            });
          });
      }

      // Carrega estados quando um país é selecionado
      function carregarEstados(force = false) {
        const paisId = document.getElementById("paisId").value;
        const estadoSelect = document.getElementById("estadoId");
        const preloaded = estadoSelect.dataset.preloaded === "true";

        if (!paisId) {
          estadoSelect.innerHTML =
            '<option value="">Selecione um Estado</option>';
          document.getElementById("cidadesContainer").innerHTML =
            '<p style="color: #666; text-align: center; margin: 0;">Selecione um Estado para carregar as cidades</p>';
          return;
        }

        if (preloaded && !force) {
          estadoSelect.dataset.preloaded = "false";
          return;
        }

        const estadoAnterior = estadoSelect.value;
        estadoSelect.innerHTML =
          '<option value="">Carregando...</option>';

        fetch("/administrador/regioes/api/estados/" + paisId)
          .then((response) => {
            if (!response.ok) {
              throw new Error("HTTP " + response.status);
            }
            return response.json();
          })
          .then((data) => {
            estadoSelect.innerHTML =
              '<option value="">Selecione um Estado</option>';
            if (Array.isArray(data) && data.length > 0) {
              data.forEach((estado) => {
                const option = document.createElement("option");
                option.value = estado.id;
                option.textContent = estado.nomeLocal;
                if (
                  estadoAnterior &&
                  Number(estadoAnterior) === Number(estado.id)
                ) {
                  option.selected = true;
                }
                estadoSelect.appendChild(option);
              });
            } else {
              estadoSelect.innerHTML +=
                '<option disabled>Nenhum estado encontrado</option>';
            }
          })
          .catch((error) => {
            console.error("Erro ao carregar estados:", error);
            estadoSelect.innerHTML =
              '<option value="">Erro ao carregar estados</option>';
          });
      }

      // Carrega cidades quando um estado é selecionado
      function carregarCidades(force = false) {
        const estadoId = document.getElementById("estadoId").value;
        const cidadesContainer = document.getElementById("cidadesContainer");
        const preloaded = cidadesContainer.dataset.preloaded === "true";

        if (!estadoId) {
          cidadesContainer.innerHTML =
            '<p style="color: #666; text-align: center; margin: 0;">Selecione um Estado para carregar as cidades</p>';
          return;
        }

        if (preloaded && !force) {
          cidadesContainer.dataset.preloaded = "false";
          registrarEventosCidades();
          return;
        }

        cidadesContainer.innerHTML =
          '<p style="color: #666; text-align: center; margin: 0;">Carregando cidades...</p>';

        fetch("/administrador/regioes/api/cidades/" + estadoId)
          .then((response) => {
            if (!response.ok) {
              throw new Error("HTTP " + response.status);
            }
            return response.json();
          })
          .then((data) => {
            if (!Array.isArray(data) || data.length === 0) {
              cidadesContainer.innerHTML =
                '<p style="color: #666; text-align: center; margin: 0;">Nenhuma cidade encontrada para este estado</p>';
              return;
            }

            cidadesContainer.innerHTML = "";
            data.forEach((cidade) => {
              const label = document.createElement("label");
              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.name = "cidadeIds";
              checkbox.value = cidade.id;
              checkbox.checked = cidadesSelecionadas.includes(cidade.id);

              label.appendChild(checkbox);
              label.appendChild(
                document.createTextNode(" " + cidade.nomeLocal)
              );
              cidadesContainer.appendChild(label);
            });
            registrarEventosCidades();
          })
          .catch((error) => {
            console.error("Erro ao carregar cidades:", error);
            cidadesContainer.innerHTML =
              '<p style="color: #d00; text-align: center; margin: 0;">Erro ao carregar cidades</p>';
          });
      }

      // Inicializa o formulário ao carregar a página
      window.addEventListener("load", function () {
        const paisId = document.getElementById("paisId").value;
        const estadoId = document.getElementById("estadoId").value;
        const cidadesContainer = document.getElementById("cidadesContainer");

        if (paisId) {
          carregarEstados(false);
        }

        if (estadoId) {
          if (cidadesContainer.dataset.preloaded === "true") {
            registrarEventosCidades();
            cidadesContainer.dataset.preloaded = "false";
          } else {
            setTimeout(() => carregarCidades(true), 300);
          }
        }
      });
    </script>
  </body>
</html>
