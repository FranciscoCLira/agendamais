<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Cadastro de Regiões - Administração</title>
    <link rel="stylesheet" th:href="@{/css/estilo.css}" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        background-color: #f5f5f5;
      }
      .container-main {
        background: #fff;
        padding: 24px;
        border-radius: 10px;
        box-shadow: 0 0 10px #ddd;
        margin: 20px auto;
        max-width: 1200px;
      }
      .table-regioes {
        font-size: 0.95rem;
      }
      .table-regioes th {
        background-color: #4b0082;
        color: white;
        font-weight: 600;
      }
      .table-regioes tbody tr:hover {
        background-color: #f9f9f9;
      }
      .badge-codigo {
        background-color: #4b0082;
        color: white;
        padding: 6px 12px;
        border-radius: 4px;
        font-weight: 600;
      }
      .btn-acao {
        padding: 4px 8px;
        font-size: 0.85rem;
      }
      .botao-novo {
        background: #4b0082;
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin-bottom: 20px;
        font-weight: 600;
      }
      .botao-novo:hover {
        background: #3d006b;
        text-decoration: none;
        color: #fff;
      }
      .mensagem-sucesso {
        color: #28a745;
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 20px;
      }
      .mensagem-erro {
        color: #721c24;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div th:replace="fragments/layout_cabecalho :: cabecalho"></div>

    <div class="container-main">
      <h1 style="margin-bottom: 20px">
        <i class="fas fa-globe"></i> Cadastro de Regiões
      </h1>

      <div th:if="${param.sucesso}">
        <div class="mensagem-sucesso">
          <i class="fas fa-check-circle"></i>
          <span th:text="${param.sucesso[0]}">Região salva com sucesso!</span>
        </div>
      </div>

      <div th:if="${param.erro}">
        <div class="mensagem-erro">
          <i class="fas fa-exclamation-circle"></i>
          <span th:text="${param.erro[0]}">Erro ao salvar região!</span>
        </div>
      </div>

      <a
        href="/administrador/regioes/novo"
        class="btn botao-novo"
        role="button"
      >
        <i class="fas fa-plus"></i> Novo Região
      </a>

      <div th:if="${regioes.isEmpty()}" class="alert alert-info">
        <i class="fas fa-info-circle"></i> Nenhuma região cadastrada.
        <a href="/administrador/regioes/novo">Criar agora</a>
      </div>

      <div th:unless="${regioes.isEmpty()}">
        <div class="table-responsive">
          <table class="table table-hover table-regioes">
            <thead>
              <tr>
                <th style="width: 10%">Código</th>
                <th style="width: 20%">Nome</th>
                <th style="width: 15%">País</th>
                <th style="width: 15%">Estado</th>
                <th style="width: 15%">Cidades</th>
                <th style="width: 10%">Atualizado</th>
                <th style="width: 15%">Ações</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="regiao : ${regioes}">
                <td>
                  <span class="badge-codigo" th:text="${regiao.codRegiao}"
                    >BR SP 01</span
                  >
                </td>
                <td th:text="${regiao.nomeRegiao}">Nome Região</td>
                <td th:text="${regiao.pais?.nomeLocal}">Brasil</td>
                <td th:text="${regiao.estado?.nomeLocal}">São Paulo</td>
                <td>
                  <span class="badge bg-info">
                    <i class="fas fa-map-marker-alt"></i>
                    <span th:text="${regiao.cidades.size()}">0</span> cidades
                  </span>
                </td>
                <td
                  th:text="${#temporals.format(regiao.dataUltimaAtualizacao, 'dd/MM/yyyy')}"
                >
                  01/01/2024
                </td>
                <td>
                  <a
                    th:href="@{/administrador/regioes/{id}/editar(id=${regiao.id})}"
                    class="btn btn-sm btn-outline-secondary btn-acao"
                    title="Editar Região"
                  >
                    <i class="fas fa-pencil-alt"></i>
                  </a>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-info btn-acao"
                    title="Listar Cidades da Região"
                    th:attr="data-regiao-id=${regiao.id},data-cod-regiao=${regiao.codRegiao}"
                    onclick="abrirModalCidades(this)"
                  >
                    <i class="fas fa-list"></i>
                  </button>
                  <a
                    th:href="@{/administrador/regioes/{id}/deletar(id=${regiao.id})}"
                    class="btn btn-sm btn-outline-danger btn-acao"
                    title="Deletar Região"
                    onclick="return confirm('Tem certeza que deseja deletar esta região?');"
                  >
                    <i class="fas fa-trash-alt"></i>
                  </a>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div
        th:replace="fragments/botao_retornar_menu :: botao-retornar-menu('/administrador')"
      ></div>

      <!-- Modal: Lista de Cidades da Região -->
      <div
        class="modal fade"
        id="modalCidades"
        tabindex="-1"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title d-flex align-items-center gap-2">
                <i class="fas fa-city"></i>
                <span id="tituloModalCidades">Cidades da Região</span>
                <span id="badgeQtdCidades" class="badge bg-info">0</span>
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <div id="listaCidades">
                <p class="text-muted mb-0">Carregando cidades...</p>
              </div>
            </div>
            <div class="modal-footer">
              <span id="totalCidadesTexto" class="me-auto text-muted"
                >Total: 0 cidades</span
              >
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Fechar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let modalCidadesInstance = null;

      function abrirModalCidades(btn) {
        const regiaoId = btn.getAttribute("data-regiao-id");
        const codRegiao = btn.getAttribute("data-cod-regiao") || "";
        const lista = document.getElementById("listaCidades");
        const badge = document.getElementById("badgeQtdCidades");
        const total = document.getElementById("totalCidadesTexto");
        const titulo = document.getElementById("tituloModalCidades");
        lista.innerHTML =
          '<p class="text-muted mb-0">Carregando cidades...</p>';
        badge.textContent = "0";
        total.textContent = "Total: 0 cidades";
        titulo.textContent =
          "Cidades da Região " + (codRegiao ? codRegiao + ":" : "");
        const modalEl = document.getElementById("modalCidades");
        if (!modalCidadesInstance) {
          modalCidadesInstance = new bootstrap.Modal(modalEl, {
            backdrop: true,
            focus: true,
          });
        }
        modalCidadesInstance.show();

        fetch("/administrador/regioes/api/" + regiaoId + "/cidades")
          .then((r) => r.json())
          .then((data) => {
            if (!data || data.length === 0) {
              badge.textContent = "0";
              total.textContent = "Total: 0 cidades";
              lista.innerHTML =
                '<p class="text-center text-muted mb-0">Nenhuma cidade cadastrada nesta região.</p>';
              return;
            }
            badge.textContent = data.length;
            total.textContent =
              "Total: " +
              data.length +
              " " +
              (data.length === 1 ? "cidade" : "cidades");
            let html = '<ul class="list-group">';
            data.forEach((c) => {
              html +=
                '<li class="list-group-item d-flex justify-content-between align-items-center">' +
                '<span><i class="fas fa-map-marker-alt"></i> ' +
                c.nomeLocal +
                "</span>" +
                "</li>";
            });
            html += "</ul>";
            lista.innerHTML = html;
          })
          .catch((err) => {
            console.error("Erro ao carregar cidades da região:", err);
            badge.textContent = "0";
            total.textContent = "Total: 0 cidades";
            lista.innerHTML =
              '<p class="text-danger">Erro ao carregar cidades.</p>';
          });
      }
    </script>
  </body>
</html>
