<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Ocorrências de Atividades</title>
    <link rel="stylesheet" href="/css/estilo.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css"
    />
    <script th:inline="javascript">
      $(function () {
        var atividadeSelecionada = null;
        var $tituloAtividade = $("input[name='tituloAtividade']");
        var $atividadeId = $("#atividadeId");
        var $novaOcorrenciaBtn = $("a.btn-primary");

        $tituloAtividade.autocomplete({
          source: function (request, response) {
            $.getJSON(
              "/administrador/ocorrencias/autocomplete-atividade",
              { term: request.term },
              function (data) {
                // Garante que cada item tenha label/value/id para o autocomplete
                var mapped = data.map(function(item) {
                  return {
                    label: item.tituloAtividade,
                    value: item.tituloAtividade,
                    id: item.id
                  };
                });
                response(mapped);
              }
            );
          },
          minLength: 2,
          select: function (event, ui) {
            atividadeSelecionada = ui.item;
            $atividadeId.val(ui.item.id);
            $tituloAtividade.val(ui.item.label); // Garante preenchimento
            $novaOcorrenciaBtn
              .removeClass("disabled")
              .attr("tabindex", "0")
              .attr("aria-disabled", "false");
            setTimeout(() => { $("#filtroOcorrenciasForm").submit(); }, 100); // Submete após preencher
          },
          change: function (event, ui) {
            // Só limpa se o campo estiver realmente vazio
            if (!ui.item && !$tituloAtividade.val()) {
                atividadeSelecionada = null;
                $atividadeId.val("");
                $novaOcorrenciaBtn
                .addClass("disabled")
                .attr("tabindex", "-1")
                .attr("aria-disabled", "true");
            }
          }
        });

        var enterPressed = false;
        $tituloAtividade.on('keydown', function(e) {
        if (e.key === 'Enter') {
            enterPressed = true;
        }
        });
        $tituloAtividade.on('keyup', function(e) {
        if (e.key === 'Enter' && enterPressed) {
            e.preventDefault();
            if ($tituloAtividade.val().length >= 2) {
            // Se não foi selecionado via mouse, submit manual
            if (!$tituloAtividade.data('ui-autocomplete-item-selected')) {
                $atividadeId.val('');
                $(this).closest('form').submit();
            }
            }
            enterPressed = false;
        }
        });
        $tituloAtividade.on('autocompleteselect', function() {
        $tituloAtividade.data('ui-autocomplete-item-selected', true);
        setTimeout(function() {
            $tituloAtividade.data('ui-autocomplete-item-selected', false);
        }, 200);
        });

        // Ao carregar a página, se já houver atividadeId, buscar o título e preencher
        if ($atividadeId.val()) {
          $.getJSON(
            "/administrador/ocorrencias/autocomplete-atividade",
            { id: $atividadeId.val() },
            function (data) {
              if (data && data.length > 0) {
                $tituloAtividade.val(data[0].tituloAtividade);
                $novaOcorrenciaBtn
                  .removeClass("disabled")
                  .attr("tabindex", "0")
                  .attr("aria-disabled", "false");
              } else {
                $tituloAtividade.val("");
                $novaOcorrenciaBtn
                  .addClass("disabled")
                  .attr("tabindex", "-1")
                  .attr("aria-disabled", "true");
              }
            }
          );
        } else {
          $tituloAtividade.val("");
          $novaOcorrenciaBtn
            .addClass("disabled")
            .attr("tabindex", "-1")
            .attr("aria-disabled", "true");
        }

        // Autocomplete para Tema da Ocorrência
        $("#temaOcorrenciaFiltro").autocomplete({
        source: function (request, response) {
            $.getJSON(
            "/administrador/ocorrencias/autocomplete-tema",
            { term: request.term },
            function (data) {
                response(data);
            }
            );
        },
    minLength: 2,
    select: function (event, ui) {
      $(this).val(ui.item.value);
      // Não submete o formulário automaticamente, permite busca parcial ao pressionar Enter
    },
    // Permite busca parcial: usuário pode digitar e clicar em Filtrar normalmente
    // Se quiser filtrar por nome exato, basta selecionar um item do autocomplete
    // Se quiser filtrar parcialmente, basta digitar e clicar em Filtrar
        });

    // Autocomplete para Autor da Ocorrência (usando autores filtrados do backend)
  var autoresDasOcorrencias = /*[[${autoresDasOcorrenciasList}]]*/ [];
  console.log("autoresDasOcorrencias:", autoresDasOcorrencias);
    console.log("autoresDasOcorrencias:", autoresDasOcorrencias);
    $("#autorNomeFiltro").autocomplete({
      source: function (request, response) {
              var termo = request.term.toLowerCase();
              var filtrados = autoresDasOcorrencias.filter(function (item) {
                return (item.nome && item.nome.toLowerCase().includes(termo)) ||
                       (item.email && item.email.toLowerCase().includes(termo));
              });
              response(filtrados.map(function (item) {
                return {
                  label: item.nome + (item.email ? ' (' + item.email + ')' : ''),
                  value: item.nome,
                  id: item.id
                };
              }));
            },
            minLength: 2,
            select: function (event, ui) {
              $("#autorIdFiltro").val(ui.item.id);
              $("#autorNomeFiltro").val(ui.item.value); // Garante preenchimento
              setTimeout(() => { $("#filtroOcorrenciasForm").submit(); }, 100);
            },
            change: function (event, ui) {
              if (!ui.item && !$(this).val()) {
                $("#autorIdFiltro").val("");
              }
            }
          });

        // Permite busca parcial ao pressionar Enter
        $("#autorNomeFiltro").on('keydown', function(e) {
        if (e.key === 'Enter') {
            var menu = $(this).autocomplete('widget');
            var items = menu.find('li.ui-menu-item');
            if (items.length === 1) {
            items.first().trigger('mouseenter').trigger('click');
            e.preventDefault();
            } else if ($(this).val().length >= 2) {
            // Busca parcial: limpa autorId e submete
            $("#autorIdFiltro").val('');
            $(this).closest('form').submit();
            e.preventDefault();
            }
        }
        });

        // Botão Limpar Filtros 

        $("#limparFiltrosBtn").on("click", function(e) {
        e.preventDefault();
  $("input[name='temaOcorrencia']").val("");
  $("input[name='autorNome']").val("");
  $("#autorIdFiltro").val("");
  $("input[name='assuntoDivulgacao']").val("");
  $("select[name='situacao']").val("");
  $("select[name='ordem']").val("data");
  $("select[name='size']").val("25");
  $("#filtroOcorrenciasForm").submit();
        });       

        // Força seleção da sugestão ao pressionar Enter (Título da Atividade)
        $tituloAtividade.on('keydown', function(e) {
        if (e.key === 'Enter') {
            var menu = $tituloAtividade.autocomplete('widget');
            var items = menu.find('li.ui-menu-item');
            if (items.length === 1) {
            items.first().trigger('mouseenter').trigger('click');
            e.preventDefault();
            }
        }
        });
        // Força seleção da sugestão ao pressionar Enter (Autor)
        $("#autorNomeFiltro").on('keydown', function(e) {
        if (e.key === 'Enter') {
            var menu = $(this).autocomplete('widget');
            var items = menu.find('li.ui-menu-item');
            if (items.length === 1) {
            items.first().trigger('mouseenter').trigger('click');
            e.preventDefault();
            }
        }
        });

        // Corrige propagação do parâmetro origem para o Voltar
        function getOrigemForVoltar() {
          // Busca o parâmetro origem do backend (preferencial) ou da URL
          // Sempre volta para o menu principal
          return 'menu';
        }
        $("a.btn-outline-secondary").on("click", function(e) {
          if ($(this).attr("id") === "voltarBtn") {
            e.preventDefault();
            window.location.href = "/administrador?origem=menu";
          }
        });
      });
    </script>
  </head>
  <body>
    <!-- Cabeçalho padrão -->
  <div th:replace="~{fragments/layout_cabecalho :: cabecalho}"></div>
    <div class="container mt-4" style="max-width: 900px">
      <div class="row mb-2 align-items-center">
        <div class="col-auto">

       <a th:if="${origem != null and origem.startsWith('/administrador/atividades')}"
         th:href="${origem}"
         class="btn btn-outline-secondary me-3">&larr; Voltar</a>
       <a th:if="${origem == null or !origem.startsWith('/administrador/atividades')}"
         th:href="@{/administrador}" class="btn btn-outline-secondary me-3">&larr; Voltar</a>

        </div>
        <div class="col text-end d-flex gap-2 justify-content-end">
          <a
            th:if="${atividadeSelecionada != null}"
            th:href="@{/administrador/ocorrencias/nova(atividadeId=${atividadeSelecionada.id}, origem=${urlAtual})}"
            class="btn btn-primary"
            tabindex="0"
            aria-disabled="false"
            >Nova Ocorrência</a>
          <a
            th:if="${atividadeSelecionada == null}"
            class="btn btn-primary disabled"
            tabindex="-1"
            aria-disabled="true"
            style="pointer-events: none; opacity: 0.7"
            >Nova Ocorrência</a>
          <a th:href="@{'/administrador/postagens/lista'(origem=${urlAtual}, tituloAtividade=${param.tituloAtividade})}" class="btn btn-outline-info ms-2">Histórico Postagens</a>
        </div>
      </div>
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-bold">Filtrar Ocorrências de Atividades</span>
          <span class="fw-bold" th:if="${totalOcorrencias != null and ocorrencias != null}" style="font-size:1rem; color:#555; min-width:220px;">
            [[${totalOcorrencias}]] Itens, sendo [[${ocorrencias.numberOfElements}]] listados
          </span>
        </div>
        <form method="get" th:action="@{/administrador/ocorrencias}" class="mb-3" id="filtroOcorrenciasForm">
    <input type="hidden" name="page" value="0" />
    <input type="hidden" name="origem" th:value="${origem}" />
    <!-- Linha destacada para Título Atividade -->
    <div class="row mb-2">
      <div class="col-12">
        <div style="background: #e9ecef; padding: 8px 12px; border-radius: 4px;">
          <label for="tituloAtividade" class="form-label fw-bold mb-1">Título da Atividade <span style="font-weight:normal; color:#888;">(autocomplete)</span></label>
          <input
            type="text"
            class="form-control border-0 bg-transparent fw-bold"
            id="tituloAtividade"
            name="tituloAtividade"
            placeholder="Digite para buscar a atividade..."
            th:value="${param.tituloAtividade}"
            required
            style="font-size: 1.1rem; font-weight: bold; background: transparent; box-shadow: none; outline: none; width:100%;"
            autocomplete="off"
          />
          <input
            type="hidden"
            id="atividadeId"
            name="atividadeId"
            th:value="${param.atividadeId}"
          />
        </div>
      </div>
    </div>
    <!-- Linha para Data, Assunto Divulg., Tema, Autor -->
    <div class="row g-2 mb-1">
      <div class="col-md-3 col-lg-3">
        <input type="date" class="form-control" name="dataInicio" id="dataInicioFiltro" th:value="${param.dataInicio}" placeholder="De" onchange="onDateFilterChange()" />
      </div>
      <div class="col-md-3 col-lg-3">
        <input type="date" class="form-control" name="dataFim" id="dataFimFiltro" th:value="${param.dataFim}" placeholder="Até" onchange="onDateFilterChange()" />
      </div>
      <div class="col-md-3 col-lg-3">
        <input type="text" class="form-control" id="assuntoDivulgacaoFiltro" name="assuntoDivulgacao" placeholder="Assunto Divulg.(autocomplete)" th:value="${param.assuntoDivulgacao}" autocomplete="off" />
      </div>
      <div class="col-md-3 col-lg-3">
        <input type="text" class="form-control" id="autorNomeFiltro" name="autorNome" placeholder="Autor (autocomplete)" th:value="${param.autorNome}" autocomplete="off" style="max-width: 200px;" />
        <input type="hidden" id="autorIdFiltro" name="autorId" th:value="${param.autorId}" />
      </div>
    </div>
    <script>
      // Validação e sensibilização do filtro de datas
      function onDateFilterChange() {
        var dataInicio = document.getElementById('dataInicioFiltro').value;
        var dataFim = document.getElementById('dataFimFiltro').value;
        if (dataInicio && dataFim) {
          if (dataFim < dataInicio) {
            alert('A Data Fim deve ser maior ou igual à Data Início.');
            document.getElementById('dataFimFiltro').value = '';
            document.getElementById('dataFimFiltro').focus();
            return;
          }
          document.getElementById('filtroOcorrenciasForm').submit();
        }
      }
      // Autocomplete para Assunto Divulgacao
      $(function() {
        $("#assuntoDivulgacaoFiltro").autocomplete({
          source: function(request, response) {
            $.getJSON("/administrador/ocorrencias/autocomplete-assunto", { term: request.term }, function(data) {
              var mapped = data.map(function(item) {
                return { label: item, value: item };
              });
              response(mapped);
            });
          },
          minLength: 2,
          select: function(event, ui) {
            $(this).val(ui.item.value);
            setTimeout(function() { $("#filtroOcorrenciasForm").submit(); }, 100);
          }
        });
      });
    </script>
            <div class="row g-2">
            <div class="col-md-3">
              <select
                class="form-select"
                style="min-width: 160px; max-width: 210px;"
                name="situacao"
                onchange="this.form.page.value=0; this.form.submit();"
              >
                <option value="" th:selected="${#strings.isEmpty(param.situacao)}">Todas</option>
                <option value="P" th:selected="${param.situacao?.toString() == 'P'}">Programada</option>
                <option value="R" th:selected="${param.situacao?.toString() == 'R'}">Realizada</option>
                <option value="C" th:selected="${param.situacao?.toString() == 'C'}">Cancelada</option>
              </select>
            </div>
            <div class="col-md-4">
              <select
                class="form-select"
                name="ordem"
                onchange="this.form.page.value=0; this.form.submit();"
              >
                <option value="data" th:selected="${#strings.isEmpty(param.ordem) or param.ordem == 'data'}">Ordem: Data/HR.Inic Desc.</option>
                <option value="dataAsc" th:selected="${param.ordem?.toString() == 'dataAsc'}">Ordem: Data/HR.Inic Asc.</option>
                <option value="situacao" th:selected="${param.ordem?.toString() == 'situacao'}">SIT., Data/HR.Inic</option>
                <option value="autor" th:selected="${param.ordem?.toString() == 'autor'}">Autor, Data/HR.Inic</option>
              </select>
            </div>
            <div class="col-md-2">
              <select
                class="form-select"
                name="size"
                onchange="this.form.page.value=0; this.form.submit();"
              >
                <option value="10" th:selected="${param.size?.toString() == '10'}">10</option>
                <option value="25" th:selected="${#strings.isEmpty(param.size) or param.size?.toString() == '25'}">25</option>
                <option value="50" th:selected="${param.size?.toString() == '50'}">50</option>
                <option value="100" th:selected="${param.size?.toString() == '100'}">100</option>
              </select>
            </div>
            <div class="col-md-2 d-flex align-items-center">
              <button type="submit" class="btn btn-primary me-2">
                Filtrar
              </button>
              <a href="#" id="limparFiltrosBtn" class="btn btn-outline-secondary">Limpar</a>
            </div>
          </div>
              <div th:if="${param.erroExclusao == '1'}" class="alert alert-danger mt-3">
                    Não é possível excluir a ocorrência: existem postagens relacionadas a ela.<br/>
                    Exclua os logs de postagem antes de tentar remover a ocorrência.
              </div>
        </form>
          <div th:if="${atividadeSelecionada == null}">
            <div class="alert alert-info">
              Selecione uma atividade para visualizar as ocorrências.
            </div>
          </div>
          <div style="height: 12px;"></div>  
          <div th:if="${atividadeSelecionada != null}">
            <table class="table table-bordered table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>#Ocor.</th>
                  <th>DATA</th>
                  <th>HR.INIC/FIM</th>
                  <th>SIT.</th>
                  <th>Q.PARTIC</th>
                  <th>ASSUNTO DIVULGAÇÃO</th>
                  <th>AUTOR</th>
                  <th style="width: 100px">Ações</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="ocorrencia : ${ocorrencias}">
                  <td th:text="${ocorrencia.id}"></td>
                  <td th:text="${ocorrencia.dataOcorrencia != null ? #temporals.format(ocorrencia.dataOcorrencia, 'dd/MM/yy') : ''}"></td>
                  <td th:text="${ocorrencia.horaInicioOcorrencia} + ' - ' + ${ocorrencia.horaFimOcorrencia}"></td>
                  <td>
                    <span th:if="${ocorrencia.situacaoOcorrencia} == 'P'" class="fw-bold text-success">P</span>
                    <span th:if="${ocorrencia.situacaoOcorrencia} == 'R'" class="fw-bold text-primary">R</span>
                    <span th:if="${ocorrencia.situacaoOcorrencia} == 'C'" class="fw-bold text-danger">C</span>
                  </td>
                  <td th:text="${ocorrencia.qtdeParticipantes}"></td>
                  <td th:text="${#strings.abbreviate(ocorrencia.assuntoDivulgacao, 50)}"></td>
                  <td th:text="${#strings.abbreviate(ocorrencia.idAutor != null && ocorrencia.idAutor.pessoa != null ? ocorrencia.idAutor.pessoa.nomePessoa : '', 20)}"></td>
                  <td>
                    <a
                      th:href="@{/administrador/ocorrencias/editar/{id}(id=${ocorrencia.id}, origem=${origem})}"
                      class="btn btn-sm btn-outline-secondary"
                      title="Editar"
                    >
                      <i class="fa fa-pencil-alt"></i>
                    </a>
                    <a
                      th:href="@{/administrador/ocorrencias/deletar/{id}(
                        id=${ocorrencia.id},
                        atividadeId=${param.atividadeId},
                        origem=${origem},
                        page=${param.page},
                        size=${param.size},
                        situacao=${param.situacao},
                        ordem=${param.ordem},
                        dataInicio=${param.dataInicio},
                        dataFim=${param.dataFim},
                        temaOcorrencia=${param.temaOcorrencia},
                        autorId=${param.autorId},
                        autorNome=${param.autorNome}
                      )}"
                      class="btn btn-sm btn-outline-danger ms-1"
                      title="Excluir"
                      th:if="${!ocorrenciasComLogs.contains(ocorrencia.id)}"
                      onclick="return confirm('Confirma exclusão?')"
                    >
                      <i class="fa fa-times"></i>
                    </a>
                    <span
                      th:if="${ocorrenciasComLogs.contains(ocorrencia.id) and ocorrencia.assuntoDivulgacao != null and !ocorrencia.assuntoDivulgacao.isEmpty()}"
                    >
                      <a th:href="@{'/administrador/postagens/lista'(assuntoDivulgacao=${ocorrencia.assuntoDivulgacao}, origem=${urlAtual})}"
                         class="btn btn-sm btn-outline-info ms-1"
                         title="Ver Histórico de Postagens deste Assunto">
                        <i class="fa fa-history"></i>
                      </a>
                    </span>
                    <a
                      th:href="@{/administrador/postagens/nova(ocorrenciaId=${ocorrencia.id}, origem=${origem})}"
                      class="btn btn-sm btn-outline-primary ms-1 btn-nova-postagem"
                      title="Nova Postagem"
                      th:attr="data-situacao=${ocorrencia.situacaoOcorrencia},data-data=${#temporals.format(ocorrencia.dataOcorrencia, 'yyyy-MM-dd')}"
                    >
                      <i class="fa fa-bullhorn"></i>
                    </a>
<script>
$(function() {
  $('.btn-nova-postagem').off('click').on('click', function(e) {
    var situacao = $(this).data('situacao');
    var dataStr = $(this).data('data'); // formato yyyy-MM-dd
    var hoje = new Date();
    var hojeStr = hoje.getFullYear() + '-' +
      String(hoje.getMonth() + 1).padStart(2, '0') + '-' +
      String(hoje.getDate()).padStart(2, '0');
    if (situacao !== 'P' || dataStr < hojeStr) {
      e.preventDefault();
      e.stopImmediatePropagation();
      alert('Só é permitido divulgar Ocorrências "Programadas" com data igual ou futura. Ocorrências passadas ou não programadas não podem ser divulgadas.');
      return false;
    }
    // Permite navegação normal
  });
});
</script>
                  </td>
                </tr>
              </tbody>
            </table>
            <!-- Paginação -->
            <nav th:if="${ocorrencias.totalPages > 1}">
              <ul class="pagination justify-content-end">
                <li
                  class="page-item"
                  th:classappend="${ocorrencias.first} ? 'disabled'"
                >
                  <a
                    class="page-link"
                    th:href="@{/administrador/ocorrencias(
                atividadeId=${param.atividadeId},
                tituloAtividade=${param.tituloAtividade},
                situacao=${param.situacao},
                ordem=${param.ordem},
                size=${param.size},
                page=${ocorrencias.number-1},
                origem=${origem}
              )}"
                    >&laquo;</a
                  >
                </li>
                <li
                  class="page-item"
                  th:each="i : ${#numbers.sequence(0, ocorrencias.totalPages-1)}"
                  th:classappend="${i == ocorrencias.number} ? 'active'"
                >
                  <a
                    class="page-link"
                    th:href="@{/administrador/ocorrencias(
                atividadeId=${param.atividadeId},
                tituloAtividade=${param.tituloAtividade},
                situacao=${param.situacao},
                ordem=${param.ordem},
                size=${param.size},
                page=${i},
                origem=${origem}
              )}"
                    th:text="${i+1}"
                  ></a>
                </li>
                <li
                  class="page-item"
                  th:classappend="${ocorrencias.last} ? 'disabled'"
                >
                  <a
                    class="page-link"
                    th:href="@{/administrador/ocorrencias(
                atividadeId=${param.atividadeId},
                tituloAtividade=${param.tituloAtividade},
                situacao=${param.situacao},
                ordem=${param.ordem},
                size=${param.size},
                page=${ocorrencias.number+1},
                origem=${origem}
              )}"
                    >&raquo;</a
                  >
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
