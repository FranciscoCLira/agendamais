<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Ocorrências de Atividades</title>
    <link rel="stylesheet" href="/css/estilo.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css"
    />
    <script>
      $(function () {
        var atividadeSelecionada = null;
        var $tituloAtividade = $("input[name='tituloAtividade']");
        var $atividadeId = $("#atividadeId");
        var $novaOcorrenciaBtn = $("a.btn-primary");

        $tituloAtividade.autocomplete({
          source: function (request, response) {
            $.getJSON(
              "/administrador/ocorrencias/autocomplete-atividade",
              { term: request.term },
              function (data) {
                response(
                  $.map(data, function (item) {
                    return {
                      label: item.tituloAtividade,
                      value: item.tituloAtividade,
                      id: item.id,
                    };
                  })
                );
              }
            );
          },
          minLength: 2,
          select: function (event, ui) {
            atividadeSelecionada = ui.item;
            $atividadeId.val(ui.item.id);
            $novaOcorrenciaBtn
              .removeClass("disabled")
              .attr("tabindex", "0")
              .attr("aria-disabled", "false");
            // Submete o formulário de filtro automaticamente ao selecionar uma atividade
            $(this).closest("form").submit();
          },
          change: function (event, ui) {
            if (!ui.item) {
              atividadeSelecionada = null;
              $atividadeId.val("");
              $novaOcorrenciaBtn
                .addClass("disabled")
                .attr("tabindex", "-1")
                .attr("aria-disabled", "true");
            }
          },
        });

        // Ao carregar a página, se já houver atividadeId, buscar o título e preencher
        if ($atividadeId.val()) {
          $.getJSON(
            "/administrador/ocorrencias/autocomplete-atividade",
            { term: "" },
            function (data) {
              var atividade = data.find(function (item) {
                return item.id == $atividadeId.val();
              });
              if (atividade) {
                $tituloAtividade.val(atividade.tituloAtividade);
                $novaOcorrenciaBtn
                  .removeClass("disabled")
                  .attr("tabindex", "0")
                  .attr("aria-disabled", "false");
              } else {
                // Se não encontrar, limpa o campo e desabilita o botão
                $tituloAtividade.val("");
                $novaOcorrenciaBtn
                  .addClass("disabled")
                  .attr("tabindex", "-1")
                  .attr("aria-disabled", "true");
              }
            }
          );
        } else {
          $tituloAtividade.val("");
          $novaOcorrenciaBtn
            .addClass("disabled")
            .attr("tabindex", "-1")
            .attr("aria-disabled", "true");
        }

        // Autocomplete para Tema da Ocorrência
        $("#temaOcorrenciaFiltro").autocomplete({
        source: function (request, response) {
            $.getJSON(
            "/administrador/ocorrencias/autocomplete-tema",
            { term: request.term },
            function (data) {
                response(data);
            }
            );
        },
        minLength: 2,
        select: function (event, ui) {
            $(this).val(ui.item.value);
            $(this).closest("form").submit();
        }
        });

        // Autocomplete para Autor da Ocorrência
        $("#autorNomeFiltro").autocomplete({
        source: function (request, response) {
            $.getJSON(
            "/administrador/ocorrencias/autocomplete-autor",
            { term: request.term },
            function (data) {
                response(
                $.map(data, function (item) {
                    return {
                    label: item.idPessoa.nomePessoa,
                    value: item.idPessoa.nomePessoa,
                    id: item.id
                    };
                })
                );
            }
            );
        },
        minLength: 2,
        select: function (event, ui) {
            $("#autorIdFiltro").val(ui.item.id);
            $(this).val(ui.item.value);
            $(this).closest("form").submit();
        },
        change: function (event, ui) {
            if (!ui.item) {
            $("#autorIdFiltro").val("");
            }
        }
        });

        // Botão Limpar Filtros 

        $("#limparFiltrosBtn").on("click", function(e) {
        e.preventDefault();
        $("input[name='temaOcorrencia']").val("");
        $("input[name='autorNome']").val("");
        $("#autorIdFiltro").val("");
        $("select[name='situacao']").val("");
        $("select[name='ordem']").val("");
        $("select[name='size']").val("25");
        $("#filtroOcorrenciasForm").submit();
        });        

      });
    </script>
  </head>
  <body>
    <!-- Cabeçalho padrão -->
    <div th:replace="fragments/layout_cabecalho :: cabecalho"></div>
    <div class="container mt-4" style="max-width: 900px">
      <div class="row mb-2 align-items-center">
        <div class="col-auto">
          <a
            th:if="(${origem} == 'atividades') or (${param.origem} == 'atividades') or (${atividadeSelecionada != null and atividadeSelecionada.id != null})"
            th:href="@{/administrador/atividades}"
            class="btn btn-outline-secondary me-3"
            >&larr; Voltar</a
          >
          <a
            th:if="! ( (${origem} == 'atividades') or (${param.origem} == 'atividades') or (${atividadeSelecionada != null and atividadeSelecionada.id != null}) )"
            th:href="@{/administrador}"
            class="btn btn-outline-secondary me-3"
            >&larr; Voltar</a
          >
        </div>
        <div class="col text-end">
          <a
            th:if="${atividadeSelecionada != null}"
            th:href="@{/administrador/ocorrencias/nova(atividadeId=${atividadeSelecionada.id}, origem=${param.origem})}"
            class="btn btn-primary"
            tabindex="0"
            aria-disabled="false"
            >Nova Ocorrência</a
          >
          <a
            th:if="${atividadeSelecionada == null}"
            class="btn btn-primary disabled"
            tabindex="-1"
            aria-disabled="true"
            style="pointer-events: none; opacity: 0.7"
            >Nova Ocorrência</a
          >
        </div>
      </div>
      <div class="card">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <div>
            <h3 class="mb-0 d-inline">Ocorrências da Atividade</h3>
            <span
              th:if="${ocorrencias != null}"
              class="ms-2 text-muted"
              th:text="'(' + ${ocorrencias.numberOfElements} + ' ocorrências listadas)'"
              style="font-size: 1rem"
            ></span>
          </div>
        </div>
        <div class="card-body">
          <form
            method="get"
            th:action="@{/administrador/ocorrencias}"
            class="mb-3"
            id="filtroOcorrenciasForm"
          >
            <input type="hidden" name="page" value="0" />
            <!-- Linha destacada para Título Atividade -->
            <div class="row mb-2">
              <div class="col-12">
                <div style="background: #e9ecef; padding: 8px 12px; border-radius: 4px;">
                  <label for="tituloAtividade" class="form-label fw-bold mb-1">Título da Atividade <span style="font-weight:normal; color:#888;">(autocomplete)</span></label>
                  <input
                    type="text"
                    class="form-control border-0 bg-transparent fw-bold"
                    id="tituloAtividade"
                    name="tituloAtividade"
                    placeholder="Digite para buscar a atividade..."
                    th:value="${param.tituloAtividade}"
                    required
                    style="font-size: 1.1rem; font-weight: bold; background: transparent; box-shadow: none; outline: none; width:100%;"
                    autocomplete="off"
                  />
                  <input
                    type="hidden"
                    id="atividadeId"
                    name="atividadeId"
                    th:value="${param.atividadeId}"
                  />
                </div>
              </div>
            </div>
            <!-- Linha para Data, Tema, Autor -->
            <div class="row g-2 mb-1">
              <div class="col-md-5 col-lg-5">
                <div class="input-group" style="min-width:320px; max-width:410px;">
                  <input type="date" class="form-control" style="min-width:140px; max-width:170px;" name="dataInicio" id="dataInicioFiltro" th:value="${param.dataInicio}" placeholder="De" onchange="onDateFilterChange()" />
                  <span class="input-group-text">à</span>
                  <input type="date" class="form-control" style="min-width:140px; max-width:170px;" name="dataFim" id="dataFimFiltro" th:value="${param.dataFim}" placeholder="Até" onchange="onDateFilterChange()" />
    <script>
      // Validação e sensibilização do filtro de datas
      function onDateFilterChange() {
        var dataInicio = document.getElementById('dataInicioFiltro').value;
        var dataFim = document.getElementById('dataFimFiltro').value;
        if (dataInicio && dataFim) {
          if (dataFim < dataInicio) {
            alert('A Data Fim deve ser maior ou igual à Data Início.');
            document.getElementById('dataFimFiltro').value = '';
            document.getElementById('dataFimFiltro').focus();
            return;
          }
          document.getElementById('filtroOcorrenciasForm').submit();
        }
      }
    </script>
                </div>
              </div>
              <div class="col-md-4 col-lg-4">
                <input
                  type="text"
                  class="form-control"
                  id="temaOcorrenciaFiltro"
                  name="temaOcorrencia"
                  placeholder="Tema (autocomplete)"
                  th:value="${param.temaOcorrencia}"
                  autocomplete="off"
                />
              </div>
              <div class="col-md-3 col-lg-3">
                <input
                  type="text"
                  class="form-control"
                  id="autorNomeFiltro"
                  name="autorNome"
                  placeholder="Autor (autocomplete)"
                  th:value="${param.autorNome}"
                  autocomplete="off"
                  style="max-width: 200px;"
                />
                <input type="hidden" id="autorIdFiltro" name="autorId" th:value="${param.autorId}" />
              </div>
            </div>
            <div class="row g-2">
            <div class="col-md-3">
              <select
                class="form-select"
                style="min-width: 160px; max-width: 210px;"
                name="situacao"
                onchange="this.form.page.value=0; this.form.submit();"
              >
                <option value="" th:selected="${#strings.isEmpty(param.situacao)}">Todas</option>
                <option value="P" th:selected="${param.situacao?.toString() == 'P'}">Programada</option>
                <option value="R" th:selected="${param.situacao?.toString() == 'R'}">Realizada</option>
                <option value="C" th:selected="${param.situacao?.toString() == 'C'}">Cancelada</option>
              </select>
            </div>
            <div class="col-md-4">
              <select
                class="form-select"
                name="ordem"
                onchange="this.form.page.value=0; this.form.submit();"
              >
                <option value="data" th:selected="${#strings.isEmpty(param.ordem) or param.ordem == 'data'}">Ordem: Data e Hora Inic</option>
                <option value="situacao" th:selected="${param.ordem?.toString() == 'situacao'}">Sit., Data e Hora Inic</option>
                <option value="autor" th:selected="${param.ordem?.toString() == 'autor'}">Autor, Data e Hora Inic</option>
              </select>
            </div>
            <div class="col-md-2">
              <select
                class="form-select"
                name="size"
                onchange="this.form.page.value=0; this.form.submit();"
              >
                <option value="10" th:selected="${param.size?.toString() == '10'}">10</option>
                <option value="25" th:selected="${#strings.isEmpty(param.size) or param.size?.toString() == '25'}">25</option>
                <option value="50" th:selected="${param.size?.toString() == '50'}">50</option>
                <option value="100" th:selected="${param.size?.toString() == '100'}">100</option>
              </select>
            </div>
            <div class="col-md-2 d-flex align-items-center">
              <button type="submit" class="btn btn-primary me-2">
                Filtrar
              </button>
              <a href="#" id="limparFiltrosBtn" class="btn btn-outline-secondary">Limpar</a>
            </div>
          </form>
          <div th:if="${atividadeSelecionada == null}">
            <div class="alert alert-info">
              Selecione uma atividade para visualizar as ocorrências.
            </div>
          </div>
          <div style="height: 12px;"></div>  
          <div th:if="${atividadeSelecionada != null}">
            <table class="table table-bordered table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>DATA</th>
                  <th>HR.INIC/FIM</th>
                  <th>SIT.</th>
                  <th>Q.PARTIC</th>
                  <th>TEMA</th>
                  <th>AUTOR</th>
                  <th style="width: 100px">Ações</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="ocorrencia : ${ocorrencias}">
                  <td
                    th:text="${ocorrencia.dataOcorrencia != null ? #temporals.format(ocorrencia.dataOcorrencia, 'dd/MM/yy') : ''}"
                  ></td>
                  <td
                    th:text="${ocorrencia.horaInicioOcorrencia} + ' - ' + ${ocorrencia.horaFimOcorrencia}"
                  ></td>
                  <td>
                    <span
                      th:if="${ocorrencia.situacaoOcorrencia} == 'P'"
                      class="fw-bold text-success"
                      >P</span
                    >
                    <span
                      th:if="${ocorrencia.situacaoOcorrencia} == 'R'"
                      class="fw-bold text-primary"
                      >R</span
                    >
                    <span
                      th:if="${ocorrencia.situacaoOcorrencia} == 'C'"
                      class="fw-bold text-danger"
                      >C</span
                    >
                  </td>
                  <td th:text="${ocorrencia.qtdeParticipantes}"></td>
                  <td
                    th:text="${#strings.abbreviate(ocorrencia.temaOcorrencia, 35)}"
                  ></td>
                  <td
                    th:text="${#strings.abbreviate(ocorrencia.idAutor != null && ocorrencia.idAutor.idPessoa != null ? ocorrencia.idAutor.idPessoa.nomePessoa : '', 20)}"
                  ></td>
                  <td>
                    <a
                      th:href="@{'/administrador/ocorrencias/editar/' + ${ocorrencia.id}}"
                      class="btn btn-sm btn-outline-secondary"
                      title="Editar"
                    >
                      <i class="fa fa-pencil-alt"></i>
                    </a>
                    <a
                      th:href="@{'/administrador/ocorrencias/deletar/' + ${ocorrencia.id}}"
                      class="btn btn-sm btn-outline-danger ms-1"
                      title="Excluir"
                      onclick="return confirm('Confirma exclusão?')"
                    >
                      <i class="fa fa-times"></i>
                    </a>
                  </td>
                </tr>
              </tbody>
            </table>
            <!-- Paginação -->
            <nav th:if="${ocorrencias.totalPages > 1}">
              <ul class="pagination justify-content-end">
                <li
                  class="page-item"
                  th:classappend="${ocorrencias.first} ? 'disabled'"
                >
                  <a
                    class="page-link"
                    th:href="@{/administrador/ocorrencias(
                atividadeId=${param.atividadeId},
                tituloAtividade=${param.tituloAtividade},
                situacao=${param.situacao},
                ordem=${param.ordem},
                size=${param.size},
                page=${ocorrencias.number-1},
                origem=${origem}
              )}"
                    >&laquo;</a
                  >
                </li>
                <li
                  class="page-item"
                  th:each="i : ${#numbers.sequence(0, ocorrencias.totalPages-1)}"
                  th:classappend="${i == ocorrencias.number} ? 'active'"
                >
                  <a
                    class="page-link"
                    th:href="@{/administrador/ocorrencias(
                atividadeId=${param.atividadeId},
                tituloAtividade=${param.tituloAtividade},
                situacao=${param.situacao},
                ordem=${param.ordem},
                size=${param.size},
                page=${i},
                origem=${origem}
              )}"
                    th:text="${i+1}"
                  ></a>
                </li>
                <li
                  class="page-item"
                  th:classappend="${ocorrencias.last} ? 'disabled'"
                >
                  <a
                    class="page-link"
                    th:href="@{/administrador/ocorrencias(
                atividadeId=${param.atividadeId},
                tituloAtividade=${param.tituloAtividade},
                situacao=${param.situacao},
                ordem=${param.ordem},
                size=${param.size},
                page=${ocorrencias.number+1},
                origem=${origem}
              )}"
                    >&raquo;</a
                  >
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
