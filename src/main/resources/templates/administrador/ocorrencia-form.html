<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title th:text="${ocorrencia.id != null} ? 'Editar Ocorrência' : 'Nova Ocorrência'">Nova Ocorrência</title>
    <link rel="stylesheet" href="/css/estilo.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />
    <script>
      $(function () {
        // Autocomplete Autor
        var $inputAutor = $("input[name='idAutor.pessoa.nomePessoa']");
        $inputAutor.autocomplete({
          source: function (request, response) {
            $.getJSON(
              "/administrador/ocorrencias/autocomplete-autor",
              { term: request.term },
              function (data) {
                response(
                  $.map(data, function (item) {
                    return {
                      label:
                        (item.pessoa && item.pessoa.nomePessoa
                          ? item.pessoa.nomePessoa
                          : "") +
                        (item.pessoa && item.pessoa.emailPessoa
                          ? " (" + item.pessoa.emailPessoa + ")"
                          : ""),
                      value:
                        item.pessoa && item.pessoa.nomePessoa
                          ? item.pessoa.nomePessoa
                          : "",
                      id: item.id,
                    };
                  })
                );
              }
            );
          },
          minLength: 2,
          select: function (event, ui) {
            $("#idAutorId").val(ui.item.id);
          },
          change: function (event, ui) {
            if (!ui.item) {
              $("#idAutorId").val("");
            }
          },
        });
        // Autocomplete Tema
        $("input[name='temaOcorrencia']").autocomplete({
          source: function (request, response) {
            $.getJSON(
              "/administrador/ocorrencias/autocomplete-tema",
              { term: request.term },
              function (data) {
                response(data);
              }
            );
          },
          minLength: 2,
        });
      });
    </script>
    <!-- Summernote WYSIWYG Editor -->
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-lite.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-lite.min.js"></script>
    <script>
      $(document).ready(function() {
        $('#detalheDivulgacao').summernote({
          placeholder: 'Digite os detalhes da divulgação...',
          tabsize: 2,
          height: 250,
          lang: 'pt-BR',
          toolbar: [
            ['style', ['bold', 'italic', 'underline', 'clear']],
            ['font', ['strikethrough', 'superscript', 'subscript']],
            ['para', ['ul', 'ol', 'paragraph']],
            ['insert', ['link', 'table']],
            ['view', ['undo', 'redo', 'codeview']]
          ]
        });
      });
      function abrirPreview() {
        var conteudo = $('#detalheDivulgacao').summernote('code');
        var win = window.open('', 'Pré-visualização', 'width=700,height=500');
        win.document.write('<html><head><title>Pré-visualização</title>');
        win.document.write('<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">');
        win.document.write('</head><body class="p-3">');
        win.document.write('<h5>Pré-visualização do texto formatado:</h5>');
        win.document.write('<div class="border rounded p-3">' + conteudo + '</div>');
        win.document.write('</body></html>');
        win.document.close();
      }
    </script>
  </head>
  <body>
    <div th:replace="fragments/layout_cabecalho :: cabecalho"></div>
    <div class="container mt-4" style="max-width: 650px">
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0" th:text="${ocorrencia.id != null} ? 'EDITAR OCORRÊNCIA DA ATIVIDADE:' : 'NOVA OCORRÊNCIA DA ATIVIDADE:'">NOVA OCORRÊNCIA DA ATIVIDADE:</h4>
          <div style="background: #e9ecef; padding: 6px 12px; border-radius: 4px; margin-top: 6px;">
            <b>Título da Atividade: </b>
            <span style="font-weight: bold" th:text="${ocorrencia.idAtividade != null ? ocorrencia.idAtividade.tituloAtividade : ''}"></span>
          </div>
        </div>
        <div class="card-body">
          <form method="post" th:object="${ocorrencia}" id="ocorrenciaForm" th:action="${ocorrencia.id != null} ? @{'/administrador/ocorrencias/editar/' + ${ocorrencia.id}} : @{'/administrador/ocorrencias/nova'}">
            <input type="hidden" name="origem" th:value="${origem}" />
            <input type="hidden" th:field="*{idAtividade.id}" />
              <div class="mb-3">
                <label class="form-label">Tema *</label>
                <input
                  type="text"
                  class="form-control"
                  th:field="*{temaOcorrencia}"
                  required
                />
              </div>
              <div class="row mb-3">
                <div class="col-md-4">
                  <label class="form-label">Data *</label>
                  <input
                    type="date"
                    class="form-control"
                    name="dataOcorrencia"
                    th:value="${ocorrencia.dataOcorrencia != null ? #temporals.format(ocorrencia.dataOcorrencia, 'yyyy-MM-dd') : ''}"
                    required
                    th:attr="min=${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}"
                  />
                  <script>
                    // Validação de hora de término maior que início
                    $(function () {
                      $("#ocorrenciaForm").on("submit", function (e) {
                        var inicio = $(
                          'input[name="horaInicioOcorrencia"]'
                        ).val();
                        var fim = $('input[name="horaFimOcorrencia"]').val();
                        if (inicio && fim && inicio >= fim) {
                          alert(
                            "A hora de término deve ser maior que a hora de início."
                          );
                          e.preventDefault();
                        }
                      });
                    });
                  </script>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Início *</label>
                  <input
                    type="time"
                    class="form-control form-control-sm"
                    style="min-width: 110px; max-width: 140px"
                    name="horaInicioOcorrencia"
                    th:value="${ocorrencia.horaInicioOcorrencia != null ? #strings.substring(ocorrencia.horaInicioOcorrencia.toString(),0,5) : ''}"
                    required
                  />
                </div>
                <div class="col-md-2">
                  <label class="form-label">Término *</label>
                  <input
                    type="time"
                    class="form-control form-control-sm"
                    style="min-width: 110px; max-width: 140px"
                    name="horaFimOcorrencia"
                    th:value="${ocorrencia.horaFimOcorrencia != null ? #strings.substring(ocorrencia.horaFimOcorrencia.toString(),0,5) : ''}"
                    required
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Situação *</label>
                <select
                  class="form-select"
                  th:field="*{situacaoOcorrencia}"
                  required
                >
                  <option value="">Selecione...</option>
                  <option value="P">Programada</option>
                  <option value="R">Realizada</option>
                  <option value="C">Cancelada</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Autor *</label>
                <input
                  type="text"
                  class="form-control"
                  th:field="*{idAutor.pessoa.nomePessoa}"
                  name="idAutor.pessoa.nomePessoa"
                  required
                  placeholder="Nome do Autor (autocomplete)"
                />
                <input
                  type="hidden"
                  id="idAutorId"
                  name="idAutorId"
                  th:value="${ocorrencia.idAutor != null ? ocorrencia.idAutor.id : ''}"
                />
              </div>
              <hr />
              <h6 class="fw-bold">DIVULGAÇÃO</h6>
              <div class="mb-2">
                <label class="form-label">Assunto</label>
                <input
                  type="text"
                  class="form-control"
                  th:field="*{assuntoDivulgacao}"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Detalhes
                  <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="abrirPreview()">Pré-visualização</button>
                </label>
                <textarea
                  class="form-control"
                  th:field="*{detalheDivulgacao}"
                  id="detalheDivulgacao"
                  rows="6"
                ></textarea>
                <!-- Summernote já incluído no <head> -->

              </div>
              <div class="mb-2">
                <label class="form-label">Link imagem</label>
                <input
                  type="text"
                  class="form-control"
                  th:field="*{linkImgDivulgacao}"
                />
              </div>
              <div class="mb-2">
                <label class="form-label">Link material</label>
                <input
                  type="text"
                  class="form-control"
                  th:field="*{linkMaterialTema}"
                />
              </div>
              <hr />
              <h6 class="fw-bold">ENCERRAMENTO</h6>
              <div class="row mb-2">
                <div class="col-md-3">
                  <label class="form-label">Qtde. Participantes</label>
                  <input
                    type="number"
                    class="form-control"
                    th:field="*{qtdeParticipantes}"
                    min="0"
                  />
                </div>
                <div class="col-md-9">
                  <label class="form-label">Observações</label>
                  <textarea
                    class="form-control"
                    th:field="*{obsEncerramento}"
                    rows="3"
                  ></textarea>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Bibliografia</label>
                <textarea
                  class="form-control"
                  th:field="*{bibliografia}"
                  rows="4"
                ></textarea>
              </div>
              <button type="submit" class="btn btn-primary">Salvar</button>
              <a
                th:href="@{/administrador/ocorrencias(atividadeId=${ocorrencia.idAtividade != null ? ocorrencia.idAtividade.id : atividadeId}, origem=${origem})}"
                class="btn btn-secondary ms-2"
                >Cancelar</a
              >
            </form>
          </div>
        </div>
      </div>
    </body>
  </html>
</form>
