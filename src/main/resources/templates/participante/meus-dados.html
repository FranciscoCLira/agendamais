<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Meus Dados</title>
    <link rel="stylesheet" href="/css/estilo.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <style>
      .form-container {
        max-width: 400px;
        margin: auto;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        min-height: auto;
        overflow: visible;
      }
      .readonly input,
      .readonly select,
      .readonly textarea {
        background: #f6f6f6;
        pointer-events: none;
        color: #555;
      }
      .mensagem-erro {
        color: #c00;
        text-align: center;
      }
      .mensagem-sucesso {
        color: #080;
        text-align: center;
      }
      .mensagem-info {
        color: #333;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div th:replace="~{fragments/layout_cabecalho :: cabecalho}"></div>
    <div class="form-container">
      <h2>Meus Dados</h2>

      <p
        th:if="${mensagemErro}"
        th:text="${mensagemErro}"
        class="mensagem-erro"
      ></p>
      <p
        th:if="${mensagemSucesso}"
        th:text="${mensagemSucesso}"
        class="mensagem-sucesso"
      ></p>
      <p id="infoMsg" class="mensagem-info"></p>

      <form
        th:action="@{/meus-dados}"
        th:object="${pessoa}"
        method="post"
        id="formMeusDados"
      >
        <div id="formFields" class="readonly">
          <label>Nome:</label>
          <input type="text" th:field="*{nomePessoa}" maxlength="80" required />

          <label>E-mail:</label>
          <input
            type="email"
            th:field="*{emailPessoa}"
            required
            placeholder="email@exemplo.com"
          />

          <label>Celular: (Ex. +55-99-99999-9999)</label>
          <input
            type="text"
            th:field="*{celularPessoa}"
            required
            placeholder="+55-99-99999-9999"
            pattern="^\+\d{2}-\d{2}-\d{4,5}-\d{4}$"
          />

          <!-- País -->
          <label>País:</label>
          <select
            id="paisSelect"
            name="nomePaisPessoa"
            required
          >
            <option value="">Selecione o país</option>
            <option
              th:each="pais : ${paises}"
              th:value="${pais.nomeLocal}"
              th:text="${pais.nomeLocal}"
              th:selected="${#strings.equalsIgnoreCase(pais.nomeLocal, pessoa.nomePais)}"
            ></option>
            <option value="Outro">Outro</option>
          </select>
          <input
            type="text"
            id="paisOutro"
            name="paisOutro"
            class="hidden"
            placeholder="Informe o País"
          />

          <!-- Estado -->
          <label>Estado:</label>
          <select
            id="estadoSelect"
            name="nomeEstadoPessoa"
            required
          >
            <option value="">Selecione</option>
            <option
              th:each="estado : ${estados}"
              th:value="${estado.nomeLocal}"
              th:text="${estado.nomeLocal}"
              th:selected="${#strings.equalsIgnoreCase(estado.nomeLocal, pessoa.nomeEstado)}"
            ></option>
            <option value="Outro">Outro</option>
          </select>
          <input
            type="text"
            id="estadoOutro"
            name="estadoOutro"
            class="hidden"
            placeholder="Informe o Estado"
          />

          <!-- Cidade -->
          <label>Cidade:</label>
          <input
            type="text"
            id="cidade"
            name="nomeCidadePessoa"
            list="listaCidades"
            th:value="${pessoa.nomeCidade}"
            required
            autocomplete="off"
            placeholder="Digite o nome da cidade ou 'Outro' para cadastrar nova"
          />
          <datalist id="listaCidades">
            <!-- Cidades são carregadas dinamicamente via JavaScript -->
          </datalist>
          <input
            type="text"
            id="cidadeOutro"
            name="cidadeOutro"
            class="hidden"
            placeholder="Informe a Cidade"
          />

          <label>Currículo:</label>
          <textarea
            th:field="*{curriculoPessoal}"
            placeholder="Opcional..."
          ></textarea>

          <label>Comentários:</label>
          <textarea
            th:field="*{comentarios}"
            name="comentarios"
            placeholder="Como chegou até aqui? Outros..."
          ></textarea>
        </div>

        <div style="text-align: center; margin-top: 20px">
          <button type="button" id="btnEditar" onclick="alternarEdicao()">
            Editar
          </button>
          <button type="submit" id="btnSalvar" style="display: none">
            Salvar Alterações
          </button>
          <a th:href="${tipoUsuario == 'participante' ? '/participante' : 
                      tipoUsuario == 'autor' ? '/autor' : 
                      tipoUsuario == 'administrador' ? '/administrador' : 
                      tipoUsuario == 'super-usuario' ? '/superusuario' : 
                      tipoUsuario == 'controle-total' ? '/controle-total' : '/participante'}"
            ><button type="button">Retornar</button></a
          >
        </div>
      </form>
    </div>
    }

    <!-- 
O script local-form.js cuida de:
- alternar campo "Outro" conforme seleção
- carregar estados/cidades via AJAX se necessário
-->
    <script src="/js/local-form.js"></script>

    <script>
      // Adiciona handlers específicos para edição
      document.addEventListener("DOMContentLoaded", function() {
        console.log("=== INIT: DOM carregado, configurando eventos ===");
        
        // Teste se o local-form.js foi carregado
        if (typeof paisChange === 'function') {
          console.log("✓ local-form.js carregado com sucesso");
        } else {
          console.error("✗ local-form.js NÃO foi carregado");
        }
        
        // Configura eventos quando a página carrega
        const paisSelect = document.getElementById("paisSelect");
        const estadoSelect = document.getElementById("estadoSelect");
        const cidadeInput = document.getElementById("cidade");
        
        if (paisSelect) {
          console.log("✓ Configurando evento para país");
          paisSelect.addEventListener("change", function(e) {
            console.log(">>> Evento país disparado:", e.target.value);
            if (typeof paisChange === 'function') {
              paisChange(e);
            } else {
              console.error("Função paisChange não encontrada!");
            }
          });
        } else {
          console.error("✗ Elemento paisSelect não encontrado");
        }
        
        if (estadoSelect) {
          console.log("✓ Configurando evento para estado");
          estadoSelect.addEventListener("change", function(e) {
            console.log(">>> Evento estado disparado:", e.target.value);
            if (typeof estadoChange === 'function') {
              estadoChange(e);
            } else {
              console.error("Função estadoChange não encontrada!");
            }
          });
        } else {
          console.error("✗ Elemento estadoSelect não encontrado");
        }
        
        if (cidadeInput) {
          console.log("✓ Configurando evento para cidade");
          cidadeInput.addEventListener("input", function(e) {
            console.log(">>> Evento cidade disparado:", e.target.value);
            if (typeof cidadeChange === 'function') {
              cidadeChange(e);
            } else {
              console.error("Função cidadeChange não encontrada!");
            }
          });
        } else {
          console.error("✗ Elemento cidadeInput não encontrado");
        }
        
        // Log do estado atual dos selects
        console.log("País atual:", paisSelect?.value);
        console.log("Estado atual:", estadoSelect?.value);
        console.log("Cidade atual:", cidadeInput?.value);
        console.log("=== FIM INIT ===");
      });

      // Alternar modo edição/readonly
      function alternarEdicao() {
        const fields = document.getElementById("formFields");
        const btnEditar = document.getElementById("btnEditar");
        const btnSalvar = document.getElementById("btnSalvar");
        const infoMsg = document.getElementById("infoMsg");
        if (fields.classList.contains("readonly")) {
          fields.classList.remove("readonly");
          Array.from(
            fields.querySelectorAll("input, select, textarea")
          ).forEach((el) => {
            el.readOnly = false;
            el.disabled = false;
          });
          btnEditar.style.display = "none";
          btnSalvar.style.display = "";
          infoMsg.innerText = "Agora é possível editar seus dados.";
        }
      }
      document.getElementById("formMeusDados").onsubmit = function (evt) {
        const fields = document.getElementById("formFields");
        if (!fields.classList.contains("readonly")) {
          
          // Debug: Log all form values before submission
          const formData = new FormData(this);
          console.log("=== FORM DATA DEBUG ===");
          for (let [key, value] of formData.entries()) {
            console.log(`${key}: '${value}'`);
          }
          console.log("Comentários field value:", document.querySelector('textarea[name="comentarios"]')?.value);
          console.log("=======================");
          
          // Corrige os valores quando país é "Outro"
          const paisSelect = document.getElementById("paisSelect");
          const paisOutro = document.getElementById("paisOutro");
          const estadoSelect = document.getElementById("estadoSelect");
          const estadoOutro = document.getElementById("estadoOutro");
          
          console.log("Antes da correção:");
          console.log("País:", paisSelect.value);
          console.log("Estado:", estadoSelect.value);
          console.log("EstadoOutro:", estadoOutro.value);
          
          if (paisSelect.value === "Outro") {
            // Se país é "Outro", garante que o estado seja enviado como "Outro"
            estadoSelect.value = "Outro";
            console.log("Definindo estado como 'Outro' porque país é 'Outro'");
          }
          
          console.log("Depois da correção:");
          console.log("País:", paisSelect.value);
          console.log("Estado:", estadoSelect.value);
          console.log("EstadoOutro:", estadoOutro.value);
          
          if (!confirm("Confirma as alterações?")) {
            evt.preventDefault();
          }
        }
      };
    </script>
  </body>
</html>
