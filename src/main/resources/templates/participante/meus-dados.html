<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Meus Dados</title>
    <link rel="stylesheet" href="/css/estilo.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <style>
      .form-container {
        max-width: 400px;
        margin: auto;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        min-height: auto;
        overflow: visible;
      }
      .readonly input,
      .readonly select,
      .readonly textarea {
        background: #f6f6f6;
        pointer-events: none;
        color: #555;
      }
      .mensagem-erro {
        color: #c00;
        text-align: center;
      }
      .mensagem-sucesso {
        color: #080;
        text-align: center;
      }
      .mensagem-info {
        color: #333;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div th:replace="~{fragments/layout_cabecalho :: cabecalho}"></div>
    <div class="form-container">
      <h2>Meus Dados</h2>

      <p
        th:if="${mensagemErro}"
        th:text="${mensagemErro}"
        class="mensagem-erro"
      ></p>
      <p
        th:if="${mensagemSucesso}"
        th:text="${mensagemSucesso}"
        class="mensagem-sucesso"
      ></p>
      <p id="infoMsg" class="mensagem-info"></p>

      <form
        th:action="@{/meus-dados}"
        th:object="${pessoa}"
        method="post"
        id="formMeusDados"
      >
        <div id="formFields" class="readonly">
          <label>Nome:</label>
          <input type="text" th:field="*{nomePessoa}" maxlength="80" required />

          <!-- Sub-Institui√ß√£o - Modo Visualiza√ß√£o e Edi√ß√£o -->
          <div style="margin: 15px 0">
            <div class="sub-instituicao-section">
              <!-- Modo Visualiza√ß√£o (readonly) -->
              <div class="sub-inst-readonly" style="display: none">
                <div style="margin-bottom: 5px">
                  <div
                    style="
                      display: flex;
                      align-items: center;
                      gap: 10px;
                      margin-bottom: 4px;
                    "
                  >
                    <span style="font-weight: bold; min-width: 130px"
                      >‚úÖSub-Institui√ß√£o:</span
                    >
                    <span
                      id="displaySubInstituicao"
                      style="
                        color: #2c5f2d;
                        font-weight: 500;
                        font-size: 0.95em;
                      "
                      th:text="${possuiVinculoSubInstituicao ? vinculoSubInstituicao.subInstituicao.nomeSubInstituicao : '(nenhuma)'}"
                    >
                      (nenhuma)
                    </span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 10px">
                    <span style="font-weight: bold; min-width: 130px"
                      >Identifica√ß√£o:</span
                    >
                    <span
                      id="displayIdentificacao"
                      style="
                        color: #2c5f2d;
                        font-weight: 500;
                        font-size: 0.95em;
                      "
                      th:text="${possuiVinculoSubInstituicao ? vinculoSubInstituicao.identificacaoPessoaSubInstituicao : '(n√£o informado)'}"
                    >
                      (n√£o informado)
                    </span>
                  </div>
                </div>
              </div>

              <!-- Modo Edi√ß√£o -->
              <div class="sub-inst-editable" style="display: none">
                <!-- Linha 1: Sub-Institui√ß√£o -->
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    margin-bottom: 8px;
                  "
                >
                  <label style="min-width: 130px; font-weight: bold"
                    >‚úÖSub-Institui√ß√£o:</label
                  >
                  <input
                    type="text"
                    id="subInstituicaoNome"
                    name="subInstituicaoNome"
                    th:value="${possuiVinculoSubInstituicao ? vinculoSubInstituicao.subInstituicao.nomeSubInstituicao : ''}"
                    placeholder="Digite ou selecione uma sub-institui√ß√£o"
                    style="
                      flex: 1;
                      padding: 6px;
                      border: 1px solid #ddd;
                      border-radius: 3px;
                      font-size: 0.9em;
                    "
                    list="subInstituicaoList"
                    maxlength="20"
                    title="M√°ximo 20 caracteres"
                  />
                  <datalist id="subInstituicaoList">
                    <!-- As op√ß√µes ser√£o carregadas via JavaScript/AJAX -->
                  </datalist>
                </div>

                <!-- Linha 2: Identifica√ß√£o -->
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    margin-bottom: 10px;
                  "
                >
                  <label style="min-width: 130px; font-weight: bold"
                    >Identifica√ß√£o:</label
                  >
                  <input
                    type="text"
                    id="identificacaoSubInstituicao"
                    name="identificacaoSubInstituicao"
                    th:value="${possuiVinculoSubInstituicao ? vinculoSubInstituicao.identificacaoPessoaSubInstituicao : ''}"
                    placeholder="ID ou c√≥digo da pessoa na sub-institui√ß√£o"
                    style="
                      flex: 1;
                      padding: 6px;
                      border: 1px solid #ddd;
                      border-radius: 3px;
                      font-size: 0.9em;
                    "
                    maxlength="17"
                    title="M√°ximo 17 caracteres"
                  />
                </div>

                <!-- Checkbox para exclus√£o (apenas no modo edi√ß√£o e se j√° existe v√≠nculo) -->
                <div
                  th:if="${possuiVinculoSubInstituicao}"
                  style="margin-top: 8px"
                >
                  <label style="font-size: 0.9em; color: #666">
                    <input
                      type="checkbox"
                      id="excluirSubInstituicao"
                      name="excluirSubInstituicao"
                      value="true"
                      style="margin-right: 5px"
                    />
                    üóëÔ∏è Remover vincula√ß√£o com sub-institui√ß√£o
                  </label>
                </div>
              </div>

              <!-- Campo hidden para indicar se √© uma opera√ß√£o de atualiza√ß√£o -->
              <input
                type="hidden"
                id="possuiaVinculo"
                name="possuiaVinculo"
                th:value="${possuiVinculoSubInstituicao}"
              />
            </div>
          </div>

          <label>E-mail:</label>
          <input
            type="email"
            th:field="*{emailPessoa}"
            required
            placeholder="email@exemplo.com"
          />

          <label>Celular: (Ex. +55-99-99999-9999)</label>
          <input
            type="text"
            th:field="*{celularPessoa}"
            required
            placeholder="+55-99-99999-9999"
            th:value="${celularPessoaFormatado}"
            onblur="formatarCelularInput(this)"
          />

<script>
function formatarCelularInput(input) {
  let v = input.value.replace(/\D/g, '');
  if (v.length === 13) {
    input.value = `+${v.substring(0,2)}-${v.substring(2,4)}-${v.substring(4,9)}-${v.substring(9)}`;
  } else if (v.length === 11) {
    input.value = `+55-${v.substring(0,2)}-${v.substring(2,7)}-${v.substring(7)}`;
  } else {
    input.value = input.value;
  }
}
</script>

          <!-- Pa√≠s -->
          <label>Pa√≠s:</label>
          <select id="paisSelect" name="nomePaisPessoa" required>
            <option value="">Selecione o pa√≠s</option>
            <option
              th:each="pais : ${paises}"
              th:value="${pais.nomeLocal}"
              th:text="${pais.nomeLocal}"
              th:selected="${#strings.equalsIgnoreCase(pais.nomeLocal, pessoa.nomePais)}"
            ></option>
            <option value="Outro">Outro</option>
          </select>
          <input
            type="text"
            id="paisOutro"
            name="paisOutro"
            class="hidden"
            placeholder="Informe o Pa√≠s"
          />

          <!-- Estado -->
          <label>Estado:</label>
          <select id="estadoSelect" name="nomeEstadoPessoa" required>
            <option value="">Selecione</option>
            <option
              th:each="estado : ${estados}"
              th:value="${estado.nomeLocal}"
              th:text="${estado.nomeLocal}"
              th:selected="${#strings.equalsIgnoreCase(estado.nomeLocal, pessoa.nomeEstado)}"
            ></option>
            <option value="Outro">Outro</option>
          </select>
          <input
            type="text"
            id="estadoOutro"
            name="estadoOutro"
            class="hidden"
            placeholder="Informe o Estado"
          />

          <!-- Cidade -->
          <label>Cidade:</label>
          <input
            type="text"
            id="cidade"
            name="nomeCidadePessoa"
            list="listaCidades"
            th:value="${pessoa.nomeCidade}"
            required
            autocomplete="off"
            placeholder="Digite o nome da cidade ou 'Outro' para cadastrar nova"
          />
          <datalist id="listaCidades">
            <!-- Cidades s√£o carregadas dinamicamente via JavaScript -->
          </datalist>
          <input
            type="text"
            id="cidadeOutro"
            name="cidadeOutro"
            class="hidden"
            placeholder="Informe a Cidade"
          />

          <label>Curr√≠culo:</label>
          <textarea
            th:field="*{curriculoPessoal}"
            placeholder="Opcional..."
          ></textarea>

          <label>Coment√°rios:</label>
          <textarea
            th:field="*{comentarios}"
            name="comentarios"
            placeholder="Como chegou at√© aqui? Outros..."
          ></textarea>
        </div>

        <div style="text-align: center; margin-top: 20px">
          <button type="button" id="btnEditar" onclick="alternarEdicao()">
            Editar
          </button>
          <button type="submit" id="btnSalvar" style="display: none">
            Salvar Altera√ß√µes
          </button>
          <a
            th:href="${tipoUsuario == 'participante' ? '/participante' : 
                      tipoUsuario == 'autor' ? '/autor' : 
                      tipoUsuario == 'administrador' ? '/administrador' : 
                      tipoUsuario == 'super-usuario' ? '/superusuario' : 
                      tipoUsuario == 'controle-total' ? '/controle-total' : '/participante'}"
            ><button type="button">Retornar</button></a
          >
        </div>
      </form>
    </div>
    }

    <!-- 
O script local-form.js cuida de:
- alternar campo "Outro" conforme sele√ß√£o
- carregar estados/cidades via AJAX se necess√°rio
-->
    <script src="/js/local-form.js"></script>

    <script>
      // Adiciona handlers espec√≠ficos para edi√ß√£o
      document.addEventListener("DOMContentLoaded", function () {
        console.log("=== INIT: DOM carregado, configurando eventos ===");

        // Teste se o local-form.js foi carregado
        if (typeof paisChange === "function") {
          console.log("‚úì local-form.js carregado com sucesso");
        } else {
          console.error("‚úó local-form.js N√ÉO foi carregado");
        }

        // Configura eventos quando a p√°gina carrega
        const paisSelect = document.getElementById("paisSelect");
        const estadoSelect = document.getElementById("estadoSelect");
        const cidadeInput = document.getElementById("cidade");

        if (paisSelect) {
          console.log("‚úì Configurando evento para pa√≠s");
          paisSelect.addEventListener("change", function (e) {
            console.log(">>> Evento pa√≠s disparado:", e.target.value);
            if (typeof paisChange === "function") {
              paisChange(e);
            } else {
              console.error("Fun√ß√£o paisChange n√£o encontrada!");
            }
          });
        } else {
          console.error("‚úó Elemento paisSelect n√£o encontrado");
        }

        if (estadoSelect) {
          console.log("‚úì Configurando evento para estado");
          estadoSelect.addEventListener("change", function (e) {
            console.log(">>> Evento estado disparado:", e.target.value);
            if (typeof estadoChange === "function") {
              estadoChange(e);
            } else {
              console.error("Fun√ß√£o estadoChange n√£o encontrada!");
            }
          });
        } else {
          console.error("‚úó Elemento estadoSelect n√£o encontrado");
        }

        if (cidadeInput) {
          console.log("‚úì Configurando evento para cidade");
          cidadeInput.addEventListener("input", function (e) {
            console.log(">>> Evento cidade disparado:", e.target.value);
            if (typeof cidadeChange === "function") {
              cidadeChange(e);
            } else {
              console.error("Fun√ß√£o cidadeChange n√£o encontrada!");
            }
          });
        } else {
          console.error("‚úó Elemento cidadeInput n√£o encontrado");
        }

        // Log do estado atual dos selects
        console.log("Pa√≠s atual:", paisSelect?.value);
        console.log("Estado atual:", estadoSelect?.value);
        console.log("Cidade atual:", cidadeInput?.value);

        // NOVA FUNCIONALIDADE: Controle de modo de visualiza√ß√£o da Sub-Institui√ß√£o
        initSubInstituicaoModeControl();

        console.log("=== FIM INIT ===");
      });

      // NOVA FUN√á√ÉO: Controla a altern√¢ncia entre modos da Sub-Institui√ß√£o
      function initSubInstituicaoModeControl() {
        console.log("Inicializando controle de modo da Sub-Institui√ß√£o...");

        // Inicia em modo readonly
        setSubInstituicaoMode("readonly");
      }

      // NOVA FUN√á√ÉO: Define o modo de exibi√ß√£o da Sub-Institui√ß√£o
      function setSubInstituicaoMode(mode) {
        const subInstReadonly = document.querySelector(".sub-inst-readonly");
        const subInstEditable = document.querySelector(".sub-inst-editable");

        if (!subInstReadonly || !subInstEditable) {
          console.log("Elementos de sub-institui√ß√£o n√£o encontrados");
          return;
        }

        if (mode === "readonly") {
          // Atualiza os valores na visualiza√ß√£o readonly
          updateSubInstituicaoDisplay();

          // Mostra readonly, esconde editable
          subInstReadonly.style.display = "block";
          subInstEditable.style.display = "none";

          console.log("Sub-Institui√ß√£o: modo readonly ativado");
        } else if (mode === "editable") {
          // Esconde readonly, mostra editable
          subInstReadonly.style.display = "none";
          subInstEditable.style.display = "block";

          console.log("Sub-Institui√ß√£o: modo editable ativado");
        }
      }

      // NOVA FUN√á√ÉO: Atualiza a exibi√ß√£o readonly com os valores dos campos edit√°veis
      function updateSubInstituicaoDisplay() {
        const nomeInput = document.getElementById("subInstituicaoNome");
        const identificacaoInput = document.getElementById(
          "identificacaoSubInstituicao"
        );
        const displayNome = document.getElementById("displaySubInstituicao");
        const displayIdent = document.getElementById("displayIdentificacao");

        if (nomeInput && identificacaoInput && displayNome && displayIdent) {
          const nome = nomeInput.value.trim();
          const ident = identificacaoInput.value.trim();

          displayNome.textContent = nome || "(nenhuma)";
          displayIdent.textContent = ident || "(n√£o informado)";

          console.log(`Sub-Institui√ß√£o display atualizado: ${nome} | ${ident}`);
        }
      }

      // Alternar modo edi√ß√£o/readonly
      function alternarEdicao() {
        const fields = document.getElementById("formFields");
        const btnEditar = document.getElementById("btnEditar");
        const btnSalvar = document.getElementById("btnSalvar");
        const infoMsg = document.getElementById("infoMsg");

        if (fields.classList.contains("readonly")) {
          fields.classList.remove("readonly");
          Array.from(
            fields.querySelectorAll("input, select, textarea")
          ).forEach((el) => {
            el.readOnly = false;
            el.disabled = false;
          });
          btnEditar.style.display = "none";
          btnSalvar.style.display = "";
          infoMsg.innerText = "Agora √© poss√≠vel editar seus dados.";

          // ATUALIZADO: Ativa modo edi√ß√£o da Sub-Institui√ß√£o
          setSubInstituicaoMode("editable");
        } else {
          // NOVO: Quando sair do modo edi√ß√£o, volta para readonly
          setSubInstituicaoMode("readonly");
        }
      }

      document.getElementById("formMeusDados").onsubmit = function (evt) {
        const fields = document.getElementById("formFields");
        if (!fields.classList.contains("readonly")) {
          // Debug: Log all form values before submission
          const formData = new FormData(this);
          console.log("=== FORM DATA DEBUG ===");
          for (let [key, value] of formData.entries()) {
            console.log(`${key}: '${value}'`);
          }
          console.log(
            "Coment√°rios field value:",
            document.querySelector('textarea[name="comentarios"]')?.value
          );
          console.log("=======================");

          // Corrige os valores quando pa√≠s √© "Outro"
          const paisSelect = document.getElementById("paisSelect");
          const paisOutro = document.getElementById("paisOutro");
          const estadoSelect = document.getElementById("estadoSelect");
          const estadoOutro = document.getElementById("estadoOutro");

          console.log("Antes da corre√ß√£o:");
          console.log("Pa√≠s:", paisSelect.value);
          console.log("Estado:", estadoSelect.value);
          console.log("EstadoOutro:", estadoOutro.value);

          if (paisSelect.value === "Outro") {
            // Se pa√≠s √© "Outro", garante que o estado seja enviado como "Outro"
            estadoSelect.value = "Outro";
            console.log("Definindo estado como 'Outro' porque pa√≠s √© 'Outro'");
          }

          console.log("Depois da corre√ß√£o:");
          console.log("Pa√≠s:", paisSelect.value);
          console.log("Estado:", estadoSelect.value);
          console.log("EstadoOutro:", estadoOutro.value);

          if (!confirm("Confirma as altera√ß√µes?")) {
            evt.preventDefault();
          } else {
            // NOVO: Ap√≥s confirma√ß√£o, volta para modo readonly
            setTimeout(() => setSubInstituicaoMode("readonly"), 100);
          }
        }
      };
    </script>

    <!-- Script para Autocomplete de Sub-Institui√ß√µes -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const subInstituicaoInput =
          document.getElementById("subInstituicaoNome");
        const subInstituicaoList =
          document.getElementById("subInstituicaoList");
        const excluirCheckbox = document.getElementById(
          "excluirSubInstituicao"
        );
        const identificacaoInput = document.getElementById(
          "identificacaoSubInstituicao"
        );

        // Carrega as sub-institui√ß√µes via AJAX
        function carregarSubInstituicoes(termo = "") {
          fetch(`/api/sub-instituicoes?q=${encodeURIComponent(termo)}`)
            .then((response) => response.json())
            .then((data) => {
              // Limpa as op√ß√µes existentes
              subInstituicaoList.innerHTML = "";

              // Adiciona as novas op√ß√µes
              data.forEach((nome) => {
                const option = document.createElement("option");
                option.value = nome;
                subInstituicaoList.appendChild(option);
              });
            })
            .catch((error) => {
              console.error("Erro ao carregar sub-institui√ß√µes:", error);
              // Fallback com dados est√°ticos
              const fallbackData = [
                "Departamento de Ci√™ncias",
                "Departamento de Engenharia",
                "Departamento de Humanas",
                "Instituto de Pesquisa",
                "Centro de Extens√£o",
                "Laborat√≥rio de Inova√ß√£o",
              ];

              subInstituicaoList.innerHTML = "";
              fallbackData.forEach((nome) => {
                const option = document.createElement("option");
                option.value = nome;
                subInstituicaoList.appendChild(option);
              });
            });
        }

        // Carrega as sub-institui√ß√µes ao inicializar
        carregarSubInstituicoes();

        // Adiciona autocomplete din√¢mico
        subInstituicaoInput.addEventListener("input", function () {
          const termo = this.value;
          if (termo.length >= 2) {
            carregarSubInstituicoes(termo);
          } else if (termo.length === 0) {
            carregarSubInstituicoes();
          }
        });

        // Controla a habilita√ß√£o/desabilita√ß√£o dos campos baseado no checkbox de exclus√£o
        if (excluirCheckbox) {
          excluirCheckbox.addEventListener("change", function () {
            const desabilitar = this.checked;
            subInstituicaoInput.disabled = desabilitar;
            identificacaoInput.disabled = desabilitar;

            if (desabilitar) {
              subInstituicaoInput.style.backgroundColor = "#f5f5f5";
              identificacaoInput.style.backgroundColor = "#f5f5f5";
            } else {
              subInstituicaoInput.style.backgroundColor = "";
              identificacaoInput.style.backgroundColor = "";
            }
          });
        }

        // Valida√ß√£o do formul√°rio para sub-institui√ß√£o
        document
          .getElementById("formMeusDados")
          .addEventListener("submit", function (e) {
            const subInstituicaoValue = subInstituicaoInput.value.trim();
            const identificacaoValue = identificacaoInput.value.trim();
            const isExcluir = excluirCheckbox && excluirCheckbox.checked;

            // Se est√° marcado para excluir, n√£o precisa validar os campos
            if (isExcluir) {
              return;
            }

            // Se preencheu sub-institui√ß√£o mas n√£o preencheu identifica√ß√£o
            // if (subInstituicaoValue && !identificacaoValue) {
            //   alert("Por favor, preencha a identifica√ß√£o da sub-institui√ß√£o.");
            //   identificacaoInput.focus();
            //   e.preventDefault();
            //   return;
            // }

            // Se preencheu identifica√ß√£o mas n√£o preencheu sub-institui√ß√£o
            if (identificacaoValue && !subInstituicaoValue) {
              alert("Por favor, selecione uma sub-institui√ß√£o.");
              subInstituicaoInput.focus();
              e.preventDefault();
              return;
            }
          });
      });
    </script>
  </body>
</html>
