<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Minhas Inscrições em Tipos de Atividades - AgendaMais</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container-fluid">
      <!-- Cabeçalho -->
      <div class="row bg-primary text-white p-3 mb-4">
        <div class="col-md-6">
          <h4 class="mb-0">
            <i class="fas fa-university me-2"></i>
            <span th:text="${nomeInstituicao}">Nome da Instituição</span>
          </h4>
        </div>
        <div class="col-md-6 text-end">
          <span class="me-3">
            <i class="fas fa-user me-1"></i>
            <span th:text="${nomeUsuario}">usuario</span>
          </span>
          <span>
            <i class="fas fa-id-badge me-1"></i>
            <span th:text="${nomePessoa}">Nome da Pessoa</span>
          </span>
        </div>
      </div>

      <!-- Mensagens -->
      <div
        th:if="${mensagemSucesso}"
        class="alert alert-success alert-dismissible fade show"
        role="alert"
      >
        <i class="fas fa-check-circle me-2"></i>
        <span th:text="${mensagemSucesso}"></span>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>

      <div
        th:if="${mensagemErro}"
        class="alert alert-danger alert-dismissible fade show"
        role="alert"
      >
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span th:text="${mensagemErro}"></span>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>

      <!-- Título da Página -->
      <div class="row mb-4">
        <div class="col-12">
          <h2>
            <i class="fas fa-clipboard-list me-2 text-primary"></i>
            Minhas Inscrições em Tipos de Atividades
          </h2>
          <p class="text-muted">
            Gerencie suas inscrições nos diferentes tipos de atividades
            disponíveis na instituição atual.
          </p>
        </div>
      </div>

      <!-- Inscrições Atuais -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div
              class="card-header bg-light d-flex justify-content-between align-items-center"
            >
              <h5 class="mb-0">
                <i class="fas fa-list-check me-2"></i>
                Minhas Inscrições Atuais
              </h5>
              <span
                class="badge bg-primary"
                th:text="'Total: ' + ${#lists.size(minhasInscricoes)}"
                >Total: 0</span
              >
            </div>
            <div class="card-body">
              <div
                th:if="${#lists.isEmpty(minhasInscricoes)}"
                class="text-center text-muted py-4"
              >
                <i class="fas fa-info-circle fa-2x mb-3"></i>
                <p>
                  Você não possui inscrições em tipos de atividades nesta
                  instituição.
                </p>
                <p class="text-sm">
                  Use o formulário abaixo para se inscrever em atividades
                  disponíveis.
                </p>
              </div>

              <div
                th:if="${!#lists.isEmpty(minhasInscricoes)}"
                class="table-responsive"
              >
                <!-- Botões de Ação em Lote -->
                <div class="mb-3 d-flex gap-2">
                  <button
                    type="button"
                    class="btn btn-danger btn-sm"
                    onclick="removerSelecionadas()"
                    id="btnRemoverSelecionadas"
                    disabled
                  >
                    <i class="fas fa-trash me-1"></i>
                    Remover Selecionadas
                  </button>
                  <span
                    id="countSelecionadas"
                    class="align-self-center text-muted small"
                  ></span>
                </div>

                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>
                        <input
                          type="checkbox"
                          id="selectAll"
                          onchange="toggleAll(this)"
                        />
                      </th>
                      <th>Tipo de Atividade</th>
                      <th>Descrição</th>
                      <th>Ações</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:each="inscricao : ${minhasInscricoes}">
                      <td>
                        <input
                          type="checkbox"
                          name="inscricoesSelecionadas"
                          th:value="${inscricao.id}"
                          class="inscricao-checkbox"
                        />
                      </td>
                      <td>
                        <strong
                          th:text="${inscricao.tipoAtividade.tituloTipoAtividade}"
                        ></strong>
                      </td>
                      <td>
                        <span
                          th:text="${inscricao.tipoAtividade.descricaoTipoAtividade ?: 'Sem descrição'}"
                          class="text-muted"
                        ></span>
                      </td>
                      <td>
                        <form
                          th:action="@{/inscricao-tipo-atividade/remover-tipo/{id}(id=${inscricao.id})}"
                          method="post"
                          onsubmit="return confirm('Tem certeza que deseja remover esta inscrição?')"
                          class="d-inline"
                        >
                          <input type="hidden" name="origem" th:value="${origem}" />
                          <button
                            type="submit"
                            class="btn btn-sm btn-outline-danger"
                          >
                            <i class="fas fa-times me-1"></i>Remover
                          </button>
                        </form>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Formulário para Adicionar Nova Inscrição -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">
                <i class="fas fa-plus me-2"></i>
                Adicionar Nova Inscrição
              </h5>
            </div>
            <div class="card-body">
              <div
                th:if="${#lists.isEmpty(tiposDisponiveis)}"
                class="text-center text-muted py-4"
              >
                <i class="fas fa-info-circle fa-2x mb-3"></i>
                <p>
                  Não há tipos de atividades disponíveis para inscrição nesta
                  instituição.
                </p>
              </div>

              <form
                th:if="${!#lists.isEmpty(tiposDisponiveis)}"
                th:action="@{/inscricao-tipo-atividade/adicionar-tipo}"
                method="post"
              >
                <input type="hidden" name="origem" th:value="${origem}" />
                <div class="row">
                  <div class="col-md-8">
                    <label for="tipoAtividadeId" class="form-label">
                      <strong>Selecione o Tipo de Atividade:</strong>
                    </label>
                    <select
                      id="tipoAtividadeId"
                      name="tipoAtividadeId"
                      class="form-select"
                      required
                    >
                      <option value="">
                        -- Selecione um tipo de atividade --
                      </option>
                      <option
                        th:each="tipo : ${tiposDisponiveis}"
                        th:value="${tipo.id}"
                        th:text="${tipo.tituloTipoAtividade + (tipo.descricaoTipoAtividade != null ? ' - ' + tipo.descricaoTipoAtividade : '')}"
                      ></option>
                    </select>
                  </div>
                  <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-success w-100">
                      <i class="fas fa-plus me-2"></i>Adicionar Inscrição
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Tipos de Atividades Disponíveis na Instituição -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>
                Todos os Tipos de Atividades da Instituição
              </h5>
            </div>
            <div class="card-body">
              <div
                th:if="${#lists.isEmpty(tiposDisponiveis)}"
                class="text-center text-muted py-4"
              >
                <i class="fas fa-info-circle fa-2x mb-3"></i>
                <p>Não há tipos de atividades cadastrados nesta instituição.</p>
              </div>

              <div
                th:if="${!#lists.isEmpty(tiposDisponiveis)}"
                class="table-responsive"
              >
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Nome</th>
                      <th>Descrição</th>
                      <th>Status da Inscrição</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:each="tipo : ${tiposDisponiveis}">
                      <td>
                        <strong th:text="${tipo.tituloTipoAtividade}"></strong>
                      </td>
                      <td>
                        <span
                          th:text="${tipo.descricaoTipoAtividade ?: 'Sem descrição'}"
                          class="text-muted"
                        ></span>
                      </td>
                      <td>
                        <!-- Verificar se está inscrito -->
                        <span
                          th:if="${minhasInscricoes.?[tipoAtividade.id == __${tipo.id}__].size() > 0}"
                          class="badge bg-primary"
                        >
                          <i class="fas fa-check me-1"></i>Inscrito
                        </span>
                        <span
                          th:if="${minhasInscricoes.?[tipoAtividade.id == __${tipo.id}__].size() == 0}"
                          class="badge bg-secondary"
                        >
                          <i class="fas fa-times me-1"></i>Não Inscrito
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Botões de Ação -->
      <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between">
          <a th:href="@{${origem == 'administrador' ? '/administrador' : (origem == 'superusuario' ? '/superusuario' : (origem == 'autor' ? '/autor' : '/participante'))}}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar
          </a>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript para funcionalidade dos checkboxes -->
    <script>
      function toggleAll(selectAllCheckbox) {
        const checkboxes = document.querySelectorAll(".inscricao-checkbox");
        checkboxes.forEach((checkbox) => {
          checkbox.checked = selectAllCheckbox.checked;
        });
        updateRemoveButton();
      }

      function updateRemoveButton() {
        const checkboxes = document.querySelectorAll(
          ".inscricao-checkbox:checked"
        );
        const btnRemover = document.getElementById("btnRemoverSelecionadas");
        const countSpan = document.getElementById("countSelecionadas");

        if (checkboxes.length > 0) {
          btnRemover.disabled = false;
          countSpan.textContent = `(${checkboxes.length} selecionada${
            checkboxes.length > 1 ? "s" : ""
          })`;
        } else {
          btnRemover.disabled = true;
          countSpan.textContent = "";
        }
      }

      function removerSelecionadas() {
        console.log("*** DEBUG - removerSelecionadas() chamada");
        const checkboxes = document.querySelectorAll(
          ".inscricao-checkbox:checked"
        );
        console.log("*** DEBUG - Checkboxes selecionados:", checkboxes.length);

        if (checkboxes.length === 0) {
          alert("Selecione pelo menos uma inscrição para remover.");
          return;
        }

        const count = checkboxes.length;
        if (
          confirm(
            `Tem certeza que deseja remover ${count} inscrição${
              count > 1 ? "ões" : ""
            }?`
          )
        ) {
          const ids = Array.from(checkboxes).map((cb) => cb.value);
          console.log("*** DEBUG - IDs selecionados:", ids);

          // Criar formulário para enviar IDs selecionados
          const form = document.createElement("form");
          form.method = "POST";
          form.action = "/inscricao-tipo-atividade/remover-multiplas";

          ids.forEach((id) => {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "inscricoesSelecionadas";
            input.value = id;
            form.appendChild(input);
            console.log(
              "*** DEBUG - Input criado:",
              input.name,
              "=",
              input.value
            );
          });

          // Adicionar campo de origem
          const origemInput = document.createElement("input");
          origemInput.type = "hidden";
          origemInput.name = "origem";
          origemInput.value = "[[${origem}]]";
          form.appendChild(origemInput);

          document.body.appendChild(form);
          console.log("*** DEBUG - Enviando formulário...");
          form.submit();
        }
      }

      // Adicionar event listener para todos os checkboxes individuais
      document.addEventListener("DOMContentLoaded", function () {
        const checkboxes = document.querySelectorAll(".inscricao-checkbox");
        checkboxes.forEach((checkbox) => {
          checkbox.addEventListener("change", updateRemoveButton);
        });
      });
    </script>
  </body>
</html>
